---
title: "part4"
author: "me"
date: "12 joulukuuta 2019"
output: html_document
---

# 4. Traits analyysi

```{r, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)

getwd()
paketit<-c("nlme","readr","tidyr","dplyr","plyr","magrittr","purrr","ggplot2","ape","geiger","MuMIn","psych","Hmisc")
lapply(paketit,library,character.only=T)
```

## 4.1 Aineisto sisään ja taulukoiden kokoaminen

```{r }
#yhdistetään ennustustarkkuustulokset ja lajiominaisuudet samaan taulukkoon
res<-read.csv("results_and_pooled.csv")

res2=subset(res,method=="pool_D")

res3=spread(res2,pa,accuracy)
res3$method=NULL

res3=res3 %>% 
  rename(
    pool_pa_change = pa,
    pool_abu_change = abu)


traits<-read.csv("traits_table.csv",sep = ";")
results<-inner_join(res3,traits,by="species")

#tallenna tarvittaessa omaksi taulukokseen
#write.csv(results,"accuracies_traits.csv",row.names = F)
```
Tarkastellaan aineistoa kuvaajista:

Poolattu 50 x 50 km aineisto, pa ja abu:

```{r }
#kuvaajien piirtely ei (ainakaan multa) onnistu jos log(Mass) ei ole valmiiksi laskettu omaan
#sarakkeeseensa
results$logmass<-log(results$Mass)

#poolattu pa aineisto
op<-par(mfrow=c(2,2),mar=c(5,4,1,2))
boxplot(pool_pa_change~Hab,data=results,ylab="pool_pa_D",xlab="Habitat")
plot(pool_pa_change~Prev, data = results,ylab="pool_pa_D",xlab="Prevalence")
abline(lm(pool_pa_change~Prev,data = results))
boxplot(pool_pa_change~Mig,data=results,ylab="pool_pa_D",xlab="Migration")
plot(pool_pa_change~logmass, data = results,ylab="pool_pa_D",xlab="log(Mass)")
abline(lm(pool_pa_change~logmass,data = results))
par(op)

#poolattu abu aineisto
op<-par(mfrow=c(2,2),mar=c(5,4,1,2))
boxplot(pool_abu_change~Hab,data=results,ylab="pool_abu_D",xlab="Habitat")
plot(pool_abu_change~Prev, data = results,ylab="pool_abu_D",xlab="Prevalence")
abline(lm(pool_abu_change~Prev,data = results))
boxplot(pool_abu_change~Mig,data=results,ylab="pool_abu_D",xlab="Migration")
plot(pool_abu_change~logmass, data = results,ylab="pool_abu_D",xlab="log(Mass)")
abline(lm(pool_abu_change~logmass,data = results))
par(op)
```

## 4.2 Fylogenia

BirdTree.org palvelusta on haettu lintujen sukupuu (tai itseasiassa tiedosto sisältää 100 vaihtoehtoista sukupuuta, joista valitaan yksi).

```{r }
#luetaan aineisto sisään, Multiphylo eli monta puuta
linnut <- read.nexus("output.nex")
#valitaan vain yksi puu, mikä tahansa sadasta
linnut2<-linnut[[99]]
#define a variance-covariance structure based on the model of Brownian evolution
bm.birds=corBrownian(1,phy=linnut2)
#tehdään fylogenialistasta matriisi
lintupuu<-vcv.phylo(linnut2)
#matriisin voi värittää havainnollistamaan lintulajien sukulaisuutta
heatmap(lintupuu,Rowv = NA,Colv = NA)

#aineiston rivien nimet muutetaan lattareiksi jolloin keskustelee fylogeniapuun kanssa
rownames(results)=results$species
```

"the so called Brownian motion (also called random walk or diffusion)
3191 model of trait evolution, which is the simplest model among the many alternative models of how
3192 traits might evolve (Beaulieu et al., 2012)."


## 4.3 Analyysit

Selvitetään, vaikuttavatko lajien ominaisuudet (muuttokäyttäytyminen 'Mig', elinympäristö 'Hab', paino 'logMass' tai prevalenssi 'Prev') ennustustarkkuuteen. Analyysissä pitäisi huomioida, että lajit voivat olla ominaisuuksiltaan samankaltaisia (ja siten omata myös yhtä suuret ennustustarkkuudet) läheisen sukulaisuussuhteen takia. 


### Pa-aineisto

Fylogenia huomioiden:

```{r }
#luodaan eri mallivaihtoehtoja
malli0 <- gls(pool_pa_change ~ 1, data = results,correlation=bm.birds,method="ML" )
malli1 <- gls(pool_pa_change ~ Mig, data = results,correlation=bm.birds,method="ML")
malli2 <- gls(pool_pa_change ~ Hab, data = results,correlation=bm.birds,method="ML")
malli3 <- gls(pool_pa_change ~ log(Mass), data = results,correlation=bm.birds,method="ML")
malli4 <- gls(pool_pa_change ~ Prev, data = results,correlation=bm.birds,method="ML")
malli5 <- gls(pool_pa_change ~ Mig + Hab, data = results,correlation=bm.birds,method="ML")
malli6 <- gls(pool_pa_change ~ Hab + log(Mass), data = results,correlation=bm.birds,method="ML")
malli7 <- gls(pool_pa_change ~ Mig + log(Mass), data = results,correlation=bm.birds,method="ML")
malli8 <- gls(pool_pa_change ~ log(Mass)+Prev, data = results,correlation=bm.birds,method="ML")
malli9 <- gls(pool_pa_change ~ Mig +Prev, data = results,correlation=bm.birds,method="ML")
malli10 <- gls(pool_pa_change ~ Hab+Prev, data = results,correlation=bm.birds,method="ML")
malli11 <- gls(pool_pa_change ~ Mig + Hab + log(Mass), data = results,correlation=bm.birds,method="ML")
malli12 <- gls(pool_pa_change ~ Mig + Hab + Prev, data = results,correlation=bm.birds,method="ML")
malli13 <- gls(pool_pa_change ~ Mig + Prev + log(Mass), data = results,correlation=bm.birds,method="ML")
malli14 <- gls(pool_pa_change ~ Prev + Hab + log(Mass), data = results,correlation=bm.birds,method="ML")
malli15 <- gls(pool_pa_change ~ Mig + Hab + log(Mass)+Prev, data = results,correlation=bm.birds,method="ML")

#mallin valintaa MuMin paketin avulla
output1<-model.sel(malli0,malli1,malli2,malli3,malli4,malli5,malli6,malli7,malli8,malli9,malli10,malli11,malli12,malli13,malli14,malli15) 

# AICc Table
output1
#malli #10 on paras mutta seuraava malli on 0.27 AICc yksikön päässä.
```

Mallit 3 ja 0 lähekkäin.   
Mallit toimivat vaikka aineistossa on mukana NA:ta.

```{r }
#tehdään model averaging
output2<-model.sel(malli0,malli3,malli8,malli4)
summary(model.avg(output2, revised.var = TRUE))
```

Mikään ei näytä selittävän ennustustarkkuutta.


```{r }
# Parameter estimate Table, katsotaan tarkemmin parasta mallia
summary(malli0)
```

Kumpi/kampi?

### Abu-aineistolle

Tämä koodi on muokattava niin, että NA:t eivät häiritse

Fylogenia huomioiden:

```{r }
#luodaan eri mallivaihtoehtoja
malli0 <- gls(pool_abu_change ~ 1, data = results,correlation=bm.birds,method="ML" ,na.action="na.exclude")
malli1 <- gls(pool_abu_change ~ Mig, data = results,correlation=bm.birds,method="ML",na.action="na.exclude")
malli2 <- gls(pool_abu_change ~ Hab, data = results,correlation=bm.birds,method="ML",na.action="na.exclude")
malli3 <- gls(pool_abu_change ~ log(Mass), data = results,correlation=bm.birds,method="ML",na.action="na.exclude")
malli4 <- gls(pool_abu_change ~ Prev, data = results,correlation=bm.birds,method="ML")
malli5 <- gls(pool_abu_change ~ Mig + Hab, data = results,correlation=bm.birds,method="ML")
malli6 <- gls(pool_abu_change ~ Hab + log(Mass), data = results,correlation=bm.birds,method="ML")
malli7 <- gls(pool_abu_change ~ Mig + log(Mass), data = results,correlation=bm.birds,method="ML")
malli8 <- gls(pool_abu_change ~ log(Mass)+Prev, data = results,correlation=bm.birds,method="ML")
malli9 <- gls(pool_abu_change ~ Mig +Prev, data = results,correlation=bm.birds,method="ML")
malli10 <- gls(pool_abu_change ~ Hab+Prev, data = results,correlation=bm.birds,method="ML")
malli11 <- gls(pool_abu_change ~ Mig + Hab + log(Mass), data = results,correlation=bm.birds,method="ML")
malli12 <- gls(pool_abu_change ~ Mig + Hab + Prev, data = results,correlation=bm.birds,method="ML")
malli13 <- gls(pool_abu_change ~ Mig + Prev + log(Mass), data = results,correlation=bm.birds,method="ML")
malli14 <- gls(pool_abu_change ~ Prev + Hab + log(Mass), data = results,correlation=bm.birds,method="ML")
malli15 <- gls(pool_abu_change ~ Mig + Hab + log(Mass)+Prev, data = results,correlation=bm.birds,method="ML")

#mallin valintaa MuMin paketin avulla
output1<-model.sel(malli0,malli1,malli2,malli3,malli4,malli5,malli6,malli7,malli8,malli9,malli10,malli11,malli12,malli13,malli14,malli15) 

# AICc Table
output1
```

Mallit 14, 15 ja 13 lähekkäin.

```{r }
#tehdään model averaging
summary(model.avg(output1, revised.var = TRUE))
```

Paino ja prevalenssi merkitseviä. Eli malli8?

```{r }
# Parameter estimate Table
summary(malli14)
summary(malli15)
summary(malli13)
summary(malli8)
```

Mikä näistä nyt siis on paras vaihtoehto?


### Mallien validointia kuvaajista, koodi

Esimerkkinä viimeisimmän aineiston malli14.

```{r }
#seuraavaksi mallin validointia kuvaajista
op<-par(mfrow=c(2,3),mar=c(5,4,1,2))
plot(malli14,add.smooth = F,which = 1)
E<-resid(malli14)
hist(E, xlab = "residuals",main = "")
plot(results$Prev,E,xlab = "prevalence",ylab="residuals")
plot(results$Hab,E,xlab = "habitat",ylab="residuals")
plot(results$Mig,E,xlab = "migration",ylab="residuals")
plot(results$logmass,E,xlab = "logMass",ylab="residuals")
par(op)
```

Residuaalit eivät ole tasaisesti jakautuneita. Ei hyvä.





