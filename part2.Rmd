---
title: "Comparing validation methods"
author: "me"
date: "4 joulukuuta 2019"
output: html_document
---
# 2. Validointimetodien vertailu

Verrataan neljällä eri metodilla laskettuja ennustustarkkuuksia. 

```{r , include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
packages<-c("readr","tidyr","dplyr","plyr","magrittr","purrr","data.table","plotrix","jtools","ggplot2","lme4","nlme")
lapply(packages,library,character.only=T)
```

```{r }
getwd()
res<-read.csv("results.csv",header=T,sep=",")
```

## 2.1 Keskiarvot ja keskivirheet

Lasketaan ennustustarkkuuksien keskiarvot ja keskivirheet kullekin metodille.

```{r }
#Compute means and standard errors
res %>% dplyr::select(2:9)%>%colMeans()
res %>% dplyr::select(2:9)%>%std.error()

#kuvaaja
boxplot(res[-1])
```

Kuvaajissa olisi varmaan hyvä pitää pa ja abu erillään?


## 2.2 Onko metodien välillä eroja?

Mallintamista varten luodaan uusi dummy-muuttuja, joka kertoo onko käytetty aineisto pa- vai abu-aineistoa. Muutan myös method-muuttujan koodausta.

```{r}
#aineiston muokkaus:
res_pa=res[,1:5]
res_pa=gather(res_pa,"method","accuracy",2:5)
res_pa$method=as.factor(revalue(res_pa$method,c("pa_A"="A","pa_B"="B","pa_C"="C","pa_D"="D")))
res_pa$pa=as.factor("pa")

res_abu=res[,c(1,6:9)]
res_abu=gather(res_abu,"method","accuracy",2:5)
res_abu$method=as.factor(revalue(res_abu$method,c("abu_A"="A","abu_B"="B","abu_C"="C","abu_D"="D")))
res_abu$pa=as.factor("abu")

res2=rbind(res_pa,res_abu)
str(res2)
```

Teen uuden kuvaajan tällä aineistolla.

```{r}
ggplot(res2,aes(x=method, y=accuracy))+geom_boxplot()+facet_grid(.~pa)
```
Varmaankin se pohjansirkku (0.95) on tuo abu_D outlier oikeassa yläkulmassa. Pitäisi varmaan poistaa? Voisi ainakin kokeilla tehdä sama analyysi ilman ko. havaintoa.

Varsinainen malli on lineaarinen sekamuuttujamalli, jossa ennustustarkkuutta selittävät metodi ja aineistotyyppi sekä niiden välinen interaktio. Lisäksi malli huomioi lajin random-tekijänä.

Testailua...
```{r}
m0=lm(accuracy~method*pa,data=res2)
summary(m0)
drop1(m0,test="F")
```

Perus lineaarinen malli näyttää, että interaktio on tärkeä.

```{r}
E1=rstandard(m0)
F1=fitted(m0)
par(mfrow=c(2,2), mar=c(5,5,2,2))
plot(x=F1,y=E1,xlab="fitted",ylab="residuals",data=res2)
abline(h=0,lty=2)
boxplot(E1~method,xlab="method",ylab="residuals",data=res2)
abline(h=0,lty=2)
boxplot(E1~pa,xlab="pa",ylab="residuals",data=res2)
abline(h=0,lty=2)
boxplot(E1~species,xlab="species",ylab="residuals",data=res2)
abline(h=0,lty=2)
```

Mutta mallin validointi paljastaa, että species sisältää vielä vaihtelua. Se pitäisi ottaa mukaan malliin. Tehdään siis sekamalli, jossa species mukana random-tekijänä (120 leveliä, 8 havaintoa per level (pa ja abu-aineistoilla 4 metodia)).

```{r}
A1=gls(accuracy~method*pa,method="REML",data=res2)
A2=lme(accuracy~method*pa,data=res2,random=~1|species,method="REML")

AIC(A1,A2)
anova(A1,A2)
summary(A2)

A2=lme(accuracy~method*pa,data=res2,random=~1|species,method="REML")

E1=resid(A2, type="normalized")
F1=fitted(A2)

par(mfrow=c(2,2), mar=c(5,5,2,2))
plot(x=F1,y=E1,xlab="fitted",ylab="residuals")
abline(h=0,lty=2)
boxplot(E1~method,xlab="method",ylab="residuals",data=res2)
abline(h=0,lty=2)
boxplot(E1~pa,xlab="pa",ylab="residuals",data=res2)
abline(h=0,lty=2)
boxplot(E1~species,xlab="species",ylab="residuals",data=res2)
abline(h=0,lty=2)

A2full=lme(accuracy~method*pa,data=res2,random=~1|species,method="ML")
A2.a=lme(accuracy~method+pa,data=res2,random=~1|species,method="ML")
A2.b=lme(accuracy~method,data=res2,random=~1|species,method="ML")
A2.c=lme(accuracy~pa,data=res2,random=~1|species,method="ML")

anova(A2full,A2.a)
AIC(A2full,A2.a,A2.b,A2.c)

A2=lme(accuracy~method*pa,data=res2,random=~1|species,method="REML")


```

Eli ennustustarkkuuteen vaikuttavat sekä metodi että aineisto. Huonoimmat tulokset saa abu-aineistolla ja metodilla D. 


## Kuvaaja

Tätä pitäisi vielä miettiä, mitä plotataan ja mitä vasten? Alun perin verrattiin metodi D:tä pa/abu_past-arvoihin eli vähän sama kuin vertailu metodi A:han. siis, voitaisiinko jo hyvin yksinkertaisella validointimenetelmällä saada samoja tuloksia kuin monimutkaisemmalla metodilla?

```{r, fig.width=14, fig.height=12}
# Piirretään kuvaaja, Fig1

#määritetään kuvalle raamit ja nimi
Line=c(-1,1)
Line2=c(-1,1)
Line3=c(0,0)

Line=cbind(Line,Line2)
Line=cbind(Line,Line3)

Line=as.data.frame(Line)

#pdf("Fig1.pdf")
#jpeg("Fig1abcdef.jpeg")
#png("Fig1abcdef.png")

#määrittää 3x3 matriisin johon kuvat piirretään
layout(matrix(c(1,2,7,3,4,7,5,6,7), 3, 3, byrow = TRUE))

# a)
plot(pa_B~pa_A,data=res,xlim=c(-1,1),
     ylim=c(-1,1),cex.axis=0.8,xlab="Prediction accuracy (A)",
     ylab="Prediction accuracy (B)")
lines(Line$Line,Line$Line2,lty="dashed")
lines(Line$Line,Line$Line3,col="grey",lty="dashed")
lines(Line$Line3,Line$Line,col="grey",lty="dashed")

text(-0.5,0.8,"a) Distribution",cex=0.8)

# b)
plot(abu_B~abu_A,data=res,xlim=c(-1,1),
     ylim=c(-1,1),cex.axis=0.8,xlab="Prediction accuracy (A)",
     ylab="Prediction accuracy (B)")
lines(Line$Line,Line$Line2,lty="dashed")
lines(Line$Line,Line$Line3,col="grey",lty="dashed")
lines(Line$Line3,Line$Line,col="grey",lty="dashed")

text(-0.5,0.8,"b) Abundance",cex=0.8)

# c)
plot(pa_D~pa_C,data=res,xlim=c(-1,1),
     ylim=c(-1,1),cex.axis=0.8,xlab="Prediction accuracy (C)",
     ylab="Prediction accuracy (D)")
lines(Line$Line,Line$Line2,lty="dashed")
lines(Line$Line,Line$Line3,col="grey",lty="dashed")
lines(Line$Line3,Line$Line,col="grey",lty="dashed")

text(-0.5,0.8,"c) Distribution, 2 km",cex=0.8)

# d)
plot(abu_D~abu_C,data=res,xlim=c(-1,1),
     ylim=c(-1,1),cex.axis=0.8,xlab="Prediction accuracy (C)",
     ylab="Prediction accuracy (D)")
lines(Line$Line,Line$Line2,lty="dashed")
lines(Line$Line,Line$Line3,col="grey",lty="dashed")
lines(Line$Line3,Line$Line,col="grey",lty="dashed")

text(-0.5,0.8,"d) Abundance, 2 km",cex=0.8)

#dev.off()
```


Millainen kuvaaja olisi hyvä?





