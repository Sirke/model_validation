visits1[i] = sum(sd1$Route==routes[i])
visits2[i] = sum(sd2$Route==routes[i])
}
#lasketaan kullekin linjalle (jolla on käyty kahdesti kummankin periodin aikana, yhteensä 592 kpl) keskiarvot periodeittain
#havainnot ja ennusteet erikseen, periodit 1 ja 2 erikseen
selroutes = routes[which(visits1>=2 & visits2>=2)]
nsr = length(selroutes)
Ap1=matrix(NA,nrow = nsr,ncol = ns)
Ap2=matrix(NA,nrow = nsr,ncol = ns)
Ay1=matrix(NA,nrow = nsr,ncol = ns)
Ay2=matrix(NA,nrow = nsr,ncol = ns)
for (i in 1:nsr){
take1 = which(sd1$Route == selroutes[i] )
take2 = which(sd2$Route == selroutes[i] )
Ap1[i,] = colMeans(pm2p1[take1,])
Ap2[i,] = colMeans(pm2p2[take2,])
Ay1[i,] = colMeans(y1[take1,]) #Suomen vesilinnut vain NA:ta
Ay2[i,] = colMeans(y2[take2,])
}
#matriisit on muutettava dataframeiksi
Ap1=as.data.frame(Ap1)
Ap1=cbind(selroutes,Ap1)
setnames(Ap1,"selroutes","Route")
Ap2=as.data.frame(Ap2)
Ap2=cbind(selroutes,Ap2)
setnames(Ap2,"selroutes","Route")
Ay1=as.data.frame(Ay1)
Ay1=cbind(selroutes,Ay1)
setnames(Ay1,"selroutes","Route")
Ay2=as.data.frame(Ay2)
Ay2=cbind(selroutes,Ay2)
setnames(Ay2,"selroutes","Route")
#lisätään havaintoihin ja ennusteisiin ensin oikeat reittikoodit (1-2591)
Ap1<-left_join(Ap1,d,by="Route")
Ap2<-left_join(Ap2,d,by="Route")
Ay1<-left_join(Ay1,d,by="Route")
Ay2<-left_join(Ay2,d,by="Route")
#...ja vihdoin myös koordinaatit
Ap1<-left_join(Ap1,xy,by=c("routeid"="route"))
Ap2<-left_join(Ap2,xy,by=c("routeid"="route"))
Ay1<-left_join(Ay1,xy,by=c("routeid"="route"))
Ay2<-left_join(Ay2,xy,by=c("routeid"="route"))
#tallenna tiedot
write.csv(Ay1,"pa_obs_per1.csv",row.names = F)
write.csv(Ay2,"pa_obs_per2.csv",row.names = F)
write.csv(Ap1,"pa_pred_per1.csv",row.names = F)
write.csv(Ap2,"pa_pred_per2.csv",row.names = F)
#luetaan sisään reitit, havainnot ja ennusteet
coordinates(Ay1)<-c("x","y")
plot(Ay1)
proj4string(Ay1) <-CRS("+init=EPSG:3035")
coordinates(Ay2)<-c("x","y")
proj4string(Ay2) <-CRS("+init=EPSG:3035")
coordinates(Ap1)<-c("x","y")
proj4string(Ap1) <-CRS("+init=EPSG:3035")
coordinates(Ap2)<-c("x","y")
proj4string(Ap2) <-CRS("+init=EPSG:3035")
#liitetään kuhunkin reittiin tieto, millä gridin ruudulla se on
pts.poly <- point.in.poly(Ay1, gridi)
data<-as.data.frame(pts.poly)
#ryhmitelään linjat gridiruuduittain ja lasketaan keskiarvot kullekin sarakkeelle, eli lajeittain.
data%>%
group_by(grid_id) %>%
summarise_at(vars(-Route), list(~mean(., na.rm=T))) %>% #jos jollain lajilla on yhdellä linjalla NA:ta se ei vaikuta keskiarvon laskemiseen.
write.csv(.,file = "pool_pa_obs_per1.csv",row.names=F)
#ja sama muille aineistoille
pts.poly <- point.in.poly(Ay2, gridi)
data<-as.data.frame(pts.poly)
data%>%
group_by(grid_id) %>%
summarise_at(vars(-Route), list(~mean(., na.rm=T))) %>%
write.csv(.,file = "pool_pa_obs_per2.csv",row.names=F)
pts.poly <- point.in.poly(Ap1, gridi)
data<-as.data.frame(pts.poly)
data%>%
group_by(grid_id) %>%
summarise_at(vars(-Route), list(~mean(., na.rm=T))) %>%
write.csv(.,file = "pool_pa_pred_per1.csv",row.names=F)
pts.poly <- point.in.poly(Ap2, gridi)
data<-as.data.frame(pts.poly)
data%>%
group_by(grid_id) %>%
summarise_at(vars(-Route), list(~mean(., na.rm=T))) %>%
write.csv(.,file = "pool_pa_pred_per2.csv",row.names=F)
#luetaan aineisto takaisin sisään
paY1<-read.csv("pool_pa_obs_per1.csv",header=T,sep=",")
paY2<-read.csv("pool_pa_obs_per2.csv",header=T,sep=",")
papred1<-read.csv("pool_pa_pred_per1.csv",header=T,sep=",")
papred2<-read.csv("pool_pa_pred_per2.csv",header=T,sep=",")
#heivataan turhat sarakkeet
names(paY1)
drops <- c("routeid","left","top","right","bottom","coords.x1","coords.x2")
paY1<-paY1[ , !(names(paY1) %in% drops)]
paY2<-paY2[ , !(names(paY2) %in% drops)]
papred1<-papred1[ , !(names(papred1) %in% drops)]
papred2<-papred2[ , !(names(papred2) %in% drops)]
#korjataan sarakkeiden lajinimet kunnollisiksi
a<-colnames(Y)
b<-"grid_id"
a<-c(b,a)
names(paY1)<-a
names(paY2)<-a
names(papred1)<-a
names(papred2)<-a
#lasketaan erotukset periodin 1 ja 2 välilä
#pa
#obs
pacounts_gather<-gather(paY1,key="Yspecies",value="Yper1",Acrocephalus_palustris:Vanellus_vanellus)
pacounts_gather2<-gather(paY2,key="Yspecies",value="Yper2",Acrocephalus_palustris:Vanellus_vanellus)
payhd<-left_join(pacounts_gather,pacounts_gather2,by=c("grid_id"="grid_id","Yspecies"="Yspecies"))
payhd$difY<-payhd$Yper2-payhd$Yper1
#pred
papred_gather<-gather(papred1,key="Pspecies",value="Pper1",Acrocephalus_palustris:Vanellus_vanellus)
papred_gather2<-gather(papred2,key="Pspecies",value="Pper2",Acrocephalus_palustris:Vanellus_vanellus)
payhdPred<-left_join(papred_gather,papred_gather2,by=c("grid_id"="grid_id","Pspecies"="Pspecies"))
payhdPred$difPred<-payhdPred$Pper2-payhdPred$Pper1
#yhdistetään tulokset, havainnot ja ennusteet samaan dataframeen
paKor<-left_join(payhd,payhdPred,by=c("grid_id"="grid_id","Yspecies"="Pspecies"))
keep<-c("Yspecies","difPred","difY")
paKor<-paKor[,keep,drop=F]
#lasketaan korrelaatiot, metodi C
paKor_C=paKor %>%
group_by(Yspecies) %>%
dplyr::summarise(pool_pa_change= cor(difPred, difY, use= "na.or.complete"))%T>%
write.csv('pa_pool50_results_methodC.csv',row.names=F)
#method A
#yhdistetään tulokset, havainnot ja ennusteet samaan dataframeen
paKor<-left_join(payhd,payhdPred,by=c("grid_id"="grid_id","Yspecies"="Pspecies"))
#lasketaan korrelaatiot
paKor_A=paKor %>%
group_by(Yspecies) %>%
dplyr::summarise(pool_pa_change= cor(Pper2, Yper2, use= "na.or.complete"))%T>%
write.csv('pa_pool50_results_methodA.csv',row.names=F)
modeltype = 2 #2 on abu-aineistolle
#model 1: data until 2006; model 2: full data
#mpred1: posterior mean based on model 1; mpred2: posterior mean based on model 2
filename = file.path(PredictionDir, paste("predictions_",c("pa","abundance")[modeltype],
"_chains_",as.character(nChains),"_thin_", as.character(thin),"_samples_", as.character(samples),
".Rdata",sep = ""))
load(filename) #mpred1, mpred2, Y, studyDesign
routes=levels(studyDesign$Route)
nr=length(routes)
years=levels(studyDesign$Year)
ns=dim(mpred1)[2]
period1=(studyDesign$Year=="Year_1996" | studyDesign$Year=="Year_1997" | studyDesign$Year=="Year_1998" | studyDesign$Year=="Year_1999")
period2=(studyDesign$Year=="Year_2013" | studyDesign$Year=="Year_2014" | studyDesign$Year=="Year_2015" | studyDesign$Year=="Year_2016")
pm1p1=mpred1[period1,]
pm1p2=mpred1[period2,] #pm1p2 = predictions by model 1 to period 2
y1=Y[period1,]
y2=Y[period2,]
sd1 = studyDesign[period1,]
sd2 = studyDesign[period2,]
visits1 = rep(NA,nr)
visits2 = rep(NA,nr)
for (i in 1:nr){
visits1[i] = sum(sd1$Route==routes[i])
visits2[i] = sum(sd2$Route==routes[i])
}
# lasketaan kullekin linjalle (jolla on k?yty kahdesti kummankin periodin aikana) keskiarvot periodeittain
#havainnot ja ennusteet erikseen
selroutes = routes[which(visits1>=2 & visits2>=2)]
nsr = length(selroutes)
Ap1=matrix(NA,nrow = nsr,ncol = ns)
Ap2=matrix(NA,nrow = nsr,ncol = ns)
Ay1=matrix(NA,nrow = nsr,ncol = ns)
Ay2=matrix(NA,nrow = nsr,ncol = ns)
for(j in 1:ns){
for (i in 1:nsr){
take1 = which(sd1$Route == selroutes[i] & y1[,j]>-1)
take2 = which(sd2$Route == selroutes[i] & y2[,j]>-1)
Ap1[i,j] = mean(pm1p1[take1,j]) #ei laske ennusteille keskiarvoa niiltä linjoilta, jotka ovat havainnoissa NA
Ap2[i,j] = mean(pm1p2[take2,j])
Ay1[i,j] = mean(y1[take1,j], na.rm=T) #NA:t jätetään huomiotta keskiarvoa laskettaessa
Ay2[i,j] = mean(y2[take2,j], na.rm=T)
}}
#matriisit on muutettava dataframeiksi
Ap1=as.data.frame(Ap1)
Ap1=cbind(selroutes,Ap1)
setnames(Ap1,"selroutes","Route")
Ap2=as.data.frame(Ap2)
Ap2=cbind(selroutes,Ap2)
setnames(Ap2,"selroutes","Route")
Ay1=as.data.frame(Ay1)
Ay1=cbind(selroutes,Ay1)
setnames(Ay1,"selroutes","Route")
Ay2=as.data.frame(Ay2)
Ay2=cbind(selroutes,Ay2)
setnames(Ay2,"selroutes","Route")
#lisätään havaintoihin ja ennusteisiin ensin oikeat reittikoodit (1-2591)
Ap1<-left_join(Ap1,d,by="Route")
Ap2<-left_join(Ap2,d,by="Route")
Ay1<-left_join(Ay1,d,by="Route")
Ay2<-left_join(Ay2,d,by="Route")
#...ja koordinaatit
Ap1<-left_join(Ap1,xy,by=c("routeid"="route"))
Ap2<-left_join(Ap2,xy,by=c("routeid"="route"))
Ay1<-left_join(Ay1,xy,by=c("routeid"="route"))
Ay2<-left_join(Ay2,xy,by=c("routeid"="route"))
#save observations and predictions for pooling in GIS
write.csv(Ay1,"abu_obs_per1.csv",row.names = F)
write.csv(Ay2,"abu_obs_per2.csv",row.names = F)
write.csv(Ap1,"abu_pred_per1.csv",row.names = F)
write.csv(Ap2,"abu_pred_per2.csv",row.names = F)
#luetaan sisään reitit koordinaatteineen
coordinates(Ay1)<-c("x","y")
proj4string(Ay1) <-CRS("+init=EPSG:3035")
coordinates(Ay2)<-c("x","y")
proj4string(Ay2) <-CRS("+init=EPSG:3035")
coordinates(Ap1)<-c("x","y")
proj4string(Ap1) <-CRS("+init=EPSG:3035")
coordinates(Ap2)<-c("x","y")
proj4string(Ap2) <-CRS("+init=EPSG:3035")
#join data based on polygons
pts.poly <- point.in.poly(Ay1, gridi)
data<-as.data.frame(pts.poly)
data%>%
group_by(grid_id) %>%
summarise_at(vars(-Route), list(~mean(., na.rm=T))) %>% #NA:t eivät vaikuta laskuihin
write.csv(.,file = "pool_abu_obs_per1.csv",row.names=F,na="")
pts.poly <- point.in.poly(Ay2, gridi)
data<-as.data.frame(pts.poly)
data%>%
group_by(grid_id) %>%
summarise_at(vars(-Route), list(~mean(., na.rm=T))) %>%
write.csv(.,file = "pool_abu_obs_per2.csv",row.names=F,na="")
pts.poly <- point.in.poly(Ap1, gridi)
data<-as.data.frame(pts.poly)
data%>%
group_by(grid_id) %>%
summarise_at(vars(-Route), list(~mean(., na.rm=T))) %>%
write.csv(.,file = "pool_abu_pred_per1.csv",row.names=F,na="")
pts.poly <- point.in.poly(Ap2, gridi)
data<-as.data.frame(pts.poly)
data%>%
group_by(grid_id) %>%
summarise_at(vars(-Route), list(~mean(., na.rm=T))) %>%
write.csv(.,file = "pool_abu_pred_per2.csv",row.names=F,na="")
paY1<-read.csv("pool_abu_obs_per1.csv",header=T,sep=",")
paY2<-read.csv("pool_abu_obs_per2.csv",header=T,sep=",")
papred1<-read.csv("pool_abu_pred_per1.csv",header=T,sep=",")
papred2<-read.csv("pool_abu_pred_per2.csv",header=T,sep=",")
#heivataan turhat sarakkeet
drops <- c("routeid","left","top","right","bottom","coords.x1","coords.x2")
paY1<-paY1[ , !(names(paY1) %in% drops)]
paY2<-paY2[ , !(names(paY2) %in% drops)]
papred1<-papred1[ , !(names(papred1) %in% drops)]
papred2<-papred2[ , !(names(papred2) %in% drops)]
#korjataan sarakkeiden lajinimet kunnollisiksi
a<-colnames(Y)
b<-"grid_id"
a<-c(b,a)
names(paY1)<-a
names(paY2)<-a
names(papred1)<-a
names(papred2)<-a
#seuraavaksi lasketaan erotukset periodin 1 ja 2 välilä
#abu
#obs
pacounts_gather<-gather(paY1,key="Yspecies",value="Yper1",Acrocephalus_palustris:Vanellus_vanellus)
pacounts_gather2<-gather(paY2,key="Yspecies",value="Yper2",Acrocephalus_palustris:Vanellus_vanellus)
payhd<-left_join(pacounts_gather,pacounts_gather2,by=c("grid_id"="grid_id","Yspecies"="Yspecies"))
payhd$difY<-payhd$Yper2-payhd$Yper1
#pred
papred_gather<-gather(papred1,key="Pspecies",value="Pper1",Acrocephalus_palustris:Vanellus_vanellus)
papred_gather2<-gather(papred2,key="Pspecies",value="Pper2",Acrocephalus_palustris:Vanellus_vanellus)
payhdPred<-left_join(papred_gather,papred_gather2,by=c("grid_id"="grid_id","Pspecies"="Pspecies"))
payhdPred$difPred<-payhdPred$Pper2-payhdPred$Pper1
#pa
abuKor<-left_join(payhd,payhdPred,by=c("grid_id"="grid_id","Yspecies"="Pspecies"))
keep<-c("Yspecies","difPred","difY")
abuKor<-abuKor[,keep,drop=F]
abuKor %>%
group_by(Yspecies) %>%
dplyr::summarise(pool_abu_change= cor(difPred, difY, use= "na.or.complete"))%T>%
write.csv('abu_pool50_results.csv',row.names=F)
observations=abuKor %>%
group_by(Yspecies) %>%
dplyr::summarise(Ngrid= length(which(!is.na(difPred))))
observations
abuKor<-left_join(payhd,payhdPred,by=c("grid_id"="grid_id","Yspecies"="Pspecies"))
abuKor_B=abuKor %>%
group_by(Yspecies) %>%
dplyr::summarise(pool_abu_change= cor(Pper2, Yper2, use= "na.or.complete"))%T>%
write.csv('abu_pool50_results_methodB.csv',row.names=F)
modeltype = 2 #2 on abu-aineistolle
#model 1: data until 2006; model 2: full data
#mpred1: posterior mean based on model 1; mpred2: posterior mean based on model 2
filename = file.path(PredictionDir, paste("predictions_",c("pa","abundance")[modeltype],
"_chains_",as.character(nChains),"_thin_", as.character(thin),"_samples_", as.character(samples),
".Rdata",sep = ""))
load(filename) #mpred1, mpred2, Y, studyDesign
routes=levels(studyDesign$Route)
nr=length(routes)
years=levels(studyDesign$Year)
ns=dim(mpred1)[2]
period1=(studyDesign$Year=="Year_1996" | studyDesign$Year=="Year_1997" | studyDesign$Year=="Year_1998" | studyDesign$Year=="Year_1999")
period2=(studyDesign$Year=="Year_2013" | studyDesign$Year=="Year_2014" | studyDesign$Year=="Year_2015" | studyDesign$Year=="Year_2016")
pm2p1=mpred2[period1,]
pm2p2=mpred2[period2,] #m2 eli käytetty koko aineistoa
y1=Y[period1,]
y2=Y[period2,]
sd1 = studyDesign[period1,]
sd2 = studyDesign[period2,]
visits1 = rep(NA,nr)
visits2 = rep(NA,nr)
for (i in 1:nr){
visits1[i] = sum(sd1$Route==routes[i])
visits2[i] = sum(sd2$Route==routes[i])
}
# lasketaan kullekin linjalle (jolla on k?yty kahdesti kummankin periodin aikana) keskiarvot periodeittain
#havainnot ja ennusteet erikseen
selroutes = routes[which(visits1>=2 & visits2>=2)]
nsr = length(selroutes)
Ap1=matrix(NA,nrow = nsr,ncol = ns)
Ap2=matrix(NA,nrow = nsr,ncol = ns)
Ay1=matrix(NA,nrow = nsr,ncol = ns)
Ay2=matrix(NA,nrow = nsr,ncol = ns)
for(j in 1:ns){
for (i in 1:nsr){
take1 = which(sd1$Route == selroutes[i] & y1[,j]>-1)
take2 = which(sd2$Route == selroutes[i] & y2[,j]>-1)
Ap1[i,j] = mean(pm2p1[take1,j]) #ei laske ennusteille keskiarvoa niiltä linjoilta, jotka ovat havainnoissa NA
Ap2[i,j] = mean(pm2p2[take2,j]) #tähän pitää myös vaihtaa pm2, jotta laskee oikeasta mallista (koko aineisto)
Ay1[i,j] = mean(y1[take1,j], na.rm=T) #NA:t jätetään huomiotta keskiarvoa laskettaessa
Ay2[i,j] = mean(y2[take2,j], na.rm=T)
}}
#matriisit on muutettava dataframeiksi
Ap1=as.data.frame(Ap1)
Ap1=cbind(selroutes,Ap1)
setnames(Ap1,"selroutes","Route")
Ap2=as.data.frame(Ap2)
Ap2=cbind(selroutes,Ap2)
setnames(Ap2,"selroutes","Route")
Ay1=as.data.frame(Ay1)
Ay1=cbind(selroutes,Ay1)
setnames(Ay1,"selroutes","Route")
Ay2=as.data.frame(Ay2)
Ay2=cbind(selroutes,Ay2)
setnames(Ay2,"selroutes","Route")
#lisätään havaintoihin ja ennusteisiin ensin oikeat reittikoodit (1-2591)
Ap1<-left_join(Ap1,d,by="Route")
Ap2<-left_join(Ap2,d,by="Route")
Ay1<-left_join(Ay1,d,by="Route")
Ay2<-left_join(Ay2,d,by="Route")
#...ja koordinaatit
Ap1<-left_join(Ap1,xy,by=c("routeid"="route"))
Ap2<-left_join(Ap2,xy,by=c("routeid"="route"))
Ay1<-left_join(Ay1,xy,by=c("routeid"="route"))
Ay2<-left_join(Ay2,xy,by=c("routeid"="route"))
#save observations and predictions for pooling in GIS
write.csv(Ay1,"abu_obs_per1.csv",row.names = F)
write.csv(Ay2,"abu_obs_per2.csv",row.names = F)
write.csv(Ap1,"abu_pred_per1.csv",row.names = F)
write.csv(Ap2,"abu_pred_per2.csv",row.names = F)
#luetaan sisään reitit koordinaatteineen
coordinates(Ay1)<-c("x","y")
proj4string(Ay1) <-CRS("+init=EPSG:3035")
coordinates(Ay2)<-c("x","y")
proj4string(Ay2) <-CRS("+init=EPSG:3035")
coordinates(Ap1)<-c("x","y")
proj4string(Ap1) <-CRS("+init=EPSG:3035")
coordinates(Ap2)<-c("x","y")
proj4string(Ap2) <-CRS("+init=EPSG:3035")
#join data based on polygons
pts.poly <- point.in.poly(Ay1, gridi)
data<-as.data.frame(pts.poly)
data%>%
group_by(grid_id) %>%
summarise_at(vars(-Route), list(~mean(., na.rm=T))) %>% #NA:t eivät vaikuta laskuihin
write.csv(.,file = "pool_abu_obs_per1.csv",row.names=F,na="")
pts.poly <- point.in.poly(Ay2, gridi)
data<-as.data.frame(pts.poly)
data%>%
group_by(grid_id) %>%
summarise_at(vars(-Route), list(~mean(., na.rm=T))) %>%
write.csv(.,file = "pool_abu_obs_per2.csv",row.names=F,na="")
pts.poly <- point.in.poly(Ap1, gridi)
data<-as.data.frame(pts.poly)
data%>%
group_by(grid_id) %>%
summarise_at(vars(-Route), list(~mean(., na.rm=T))) %>%
write.csv(.,file = "pool_abu_pred_per1.csv",row.names=F,na="")
pts.poly <- point.in.poly(Ap2, gridi)
data<-as.data.frame(pts.poly)
data%>%
group_by(grid_id) %>%
summarise_at(vars(-Route), list(~mean(., na.rm=T))) %>%
write.csv(.,file = "pool_abu_pred_per2.csv",row.names=F,na="")
#luetaan aineisto takaisin sisään
paY1<-read.csv("pool_abu_obs_per1.csv",header=T,sep=",")
paY2<-read.csv("pool_abu_obs_per2.csv",header=T,sep=",")
papred1<-read.csv("pool_abu_pred_per1.csv",header=T,sep=",")
papred2<-read.csv("pool_abu_pred_per2.csv",header=T,sep=",")
#heivataan turhat sarakkeet
drops <- c("routeid","left","top","right","bottom","coords.x1","coords.x2")
paY1<-paY1[ , !(names(paY1) %in% drops)]
paY2<-paY2[ , !(names(paY2) %in% drops)]
papred1<-papred1[ , !(names(papred1) %in% drops)]
papred2<-papred2[ , !(names(papred2) %in% drops)]
#korjataan sarakkeiden lajinimet kunnollisiksi
a<-colnames(Y)
b<-"grid_id"
a<-c(b,a)
names(paY1)<-a
names(paY2)<-a
names(papred1)<-a
names(papred2)<-a
#seuraavaksi lasketaan erotukset periodin 1 ja 2 välilä
#abu
#obs
pacounts_gather<-gather(paY1,key="Yspecies",value="Yper1",Acrocephalus_palustris:Vanellus_vanellus)
pacounts_gather2<-gather(paY2,key="Yspecies",value="Yper2",Acrocephalus_palustris:Vanellus_vanellus)
payhd<-left_join(pacounts_gather,pacounts_gather2,by=c("grid_id"="grid_id","Yspecies"="Yspecies"))
payhd$difY<-payhd$Yper2-payhd$Yper1
#pred
papred_gather<-gather(papred1,key="Pspecies",value="Pper1",Acrocephalus_palustris:Vanellus_vanellus)
papred_gather2<-gather(papred2,key="Pspecies",value="Pper2",Acrocephalus_palustris:Vanellus_vanellus)
payhdPred<-left_join(papred_gather,papred_gather2,by=c("grid_id"="grid_id","Pspecies"="Pspecies"))
payhdPred$difPred<-payhdPred$Pper2-payhdPred$Pper1
#abu
abuKor<-left_join(payhd,payhdPred,by=c("grid_id"="grid_id","Yspecies"="Pspecies"))
keep<-c("Yspecies","difPred","difY")
abuKor<-abuKor[,keep,drop=F]
abuKor_C=abuKor %>%
group_by(Yspecies) %>%
dplyr::summarise(pool_abu_change= cor(difPred, difY, use= "na.or.complete"))%T>%
write.csv('abu_pool50_results_methodC.csv',row.names=F)
abuKor<-left_join(payhd,payhdPred,by=c("grid_id"="grid_id","Yspecies"="Pspecies"))
abuKor_A=abuKor %>%
group_by(Yspecies) %>%
dplyr::summarise(pool_abu_change= cor(Pper2, Yper2, use= "na.or.complete"))%T>%
write.csv('abu_pool50_results_methodA.csv',row.names=F)
#kaikki data sisään
res<-read.csv("results_with_NA.csv") #jo aiemmin lasketut ei-poolatut tarkkuudet
pool_pa<-read.csv("pa_pool50_results.csv")
pool_abu<-read.csv("abu_pool50_results.csv")
pool_paC=read.csv("pa_pool50_results_methodC.csv")
pool_paB=read.csv("pa_pool50_results_methodB.csv")
pool_paA=read.csv("pa_pool50_results_methodA.csv")
pool_abuC=read.csv("abu_pool50_results_methodC.csv")
pool_abuB=read.csv("abu_pool50_results_methodB.csv")
pool_abuA=read.csv("abu_pool50_results_methodA.csv")
#100km gridi
#pool_pa<-read.csv("pa_pool100_results.csv")
#pool_abu<-read.csv("abu_pool100_results.csv")
#muokataan taulukoita
pool_pa$method=as.factor("pool_D")
pool_pa$pa=as.factor("pa")
pool_abu$method=as.factor("pool_D")
pool_abu$pa=as.factor("abu")
pool_pa=pool_pa %>% dplyr::rename(species = Yspecies, accuracy = pool_pa_change)
pool_abu=pool_abu %>% dplyr::rename(species = Yspecies,accuracy = pool_abu_change)
pool_paC$method=as.factor("pool_C")
pool_paB$method=as.factor("pool_B")
pool_paA$method=as.factor("pool_A")
pool_paC$pa=as.factor("pa")
pool_paB$pa=as.factor("pa")
pool_paA$pa=as.factor("pa")
pool_abuC$method=as.factor("pool_C")
pool_abuB$method=as.factor("pool_B")
pool_abuA$method=as.factor("pool_A")
pool_abuC$pa=as.factor("abu")
pool_abuB$pa=as.factor("abu")
pool_abuA$pa=as.factor("abu")
helpabu=rbind(pool_abuC,pool_abuB,pool_abuA)
helppa=rbind(pool_paC,pool_paB,pool_paA)
helpabu=helpabu %>% dplyr::rename(species = Yspecies, accuracy = pool_abu_change)
helppa=helppa %>% dplyr::rename(species = Yspecies,accuracy = pool_pa_change)
help=rbind(helpabu,helppa)
#yhdistetään kaikki tulokset samaan taulukkoon
res2=rbind(res,pool_abu,pool_pa,help)
str(res2)
summary(res2)
res2$accuracy[res2$species == "Emberiza_rustica" & res2$method == "pool_D" & res2$pa == "abu"] <- NA
res2$accuracy[res2$species == "Bonasa_bonasia" & res2$method == "pool_D" & res2$pa == "abu"] <- NA
res2$accuracy[res2$species == "Emberiza_rustica" & res2$method == "pool_C" & res2$pa == "abu"] <- NA
res2$accuracy[res2$species == "Bonasa_bonasia" & res2$method == "pool_C" & res2$pa == "abu"] <- NA
#tallennetaan
write.csv(res2,"results_and_pooled.csv",row.names=F)
traits<-read.csv("traits_table.csv",sep = ";")
table=res2%>%unite("method",method,pa)%>%spread(method, accuracy)%>%inner_join(.,traits,by="species")
summary(table)
write.csv(table,"table.csv")
#plottailua
ggplot(res2, aes(x = method, y = accuracy,  colour = pa)) + geom_boxplot() +facet_grid(.~pa)
#aineisto uusiksi, lisään muuttujan 'pool' , joka jakaa tarkkuudet ei-poolattuihin ja poolattuihin
poolres=res2
poolres$pool=NA
poolres$pool[poolres$method=="A"|poolres$method=="B"|poolres$method=="C"|poolres$method=="D"]<-"NPo"
poolres$pool[poolres$method=="pool_A"|poolres$method=="pool_B"|poolres$method=="pool_C"|poolres$method=="pool_D"]<-"Po"
poolres$pool=as.factor(poolres$pool)
poolres$method=stringr::str_replace(poolres$method,'pool_','')
poolres$method=as.factor(poolres$method)
#tarkistellaan taulukkona, tää ei nyt jostain syystä skulaa?!
poolres %>%
group_by(method, pa, pool) %>%
summarise(mean = mean(accuracy,na.rm=T),std.errors=std.error(accuracy,na.rm=T))
#plottailua
ggplot(poolres,aes(x=method,y=accuracy,color=pool))+geom_boxplot()+facet_grid(.~pa)
#tallenna
write.csv(poolres, "poolres.csv",row.names = F)
#jaetaan aineisto pa ja abu aineistoihin
poolresPA=subset(poolres,pa=="pa")
poolresABU=subset(poolres,pa=="abu")
#luetaan aineisto sisään, Multiphylo eli monta puuta
linnut <- read.nexus("output.nex")
#valitaan vain yksi puu, mikä tahansa sadasta
linnut2<-linnut[[99]]
#tehdään puusta malliin sopiva fylogeniarakenne
bm.birds<-inverseA(linnut2)$Ainv
M1<- MCMCglmm(accuracy ~ method * pool, random=~species, data = resPA,family="gaussian",  ginverse=list(species=bm.birds),nitt=1003000, burnin=3000, thin=1000)
M1<- MCMCglmm(accuracy ~ method * pool, random=~species, data = poolresPA,family="gaussian",  ginverse=list(species=bm.birds),nitt=1003000, burnin=3000, thin=1000)
