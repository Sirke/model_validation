species=colnames(Y)
pa_results=data.frame(species,A,B,C,D)
setnames(pa_results,c("A","B","C","D"),c("pa_A","pa_B","pa_C","pa_D"))
write.csv(pa_results, "pa_results.csv",row.names = F)
pa_results
#kannanmuutostrendien tarkastelu, lasketaan kaikilta linjoilta ennustetut ja todelliset kannanmuutokset
Ap1<-as.data.frame(Ap1)
Ap2<-as.data.frame(Ap2)
Ay<-as.data.frame(Ay)
#aineisto, jossa kullekin lajille laskettu kaikilta linjoilta ennustettu ja todellinen muutoksen keskiarvo (EI siis korrelaatio
# ennusteiden ja oikeiden muutosten välillä kuten aiemmin on laskettu vaan vähän niinkuin olisi poolattu koko aineisto yhteen lukemaan)
kat=colnames(Y)
kat=as.data.frame(kat)
kat$Ap1k=colMeans(Ap1,na.rm = T)
kat$Ap2k<-colMeans(Ap2,na.rm = T)
kat$Ayk<-colMeans(Ay,na.rm = T)
ggplot(kat, aes(x=Ap2k, y=Ayk))+ geom_point()+
geom_hline(yintercept = 0, color = "black")+
geom_vline(xintercept = 0, color = "black")+
xlab("Mean predicted change, C")+
ylab("Mean observed change")+
geom_abline(intercept = 0, slope = 1, color="red",linetype="dashed", size=1.5)+
geom_text(aes(label=kat),hjust=0, vjust=0) + geom_smooth()
ggplot(kat, aes(x=Ap1k, y=Ayk))+
geom_point()+ geom_hline(yintercept = 0, color = "black")+
geom_vline(xintercept = 0, color = "black")+
xlab("Mean predicted change, D")+
ylab("Mean observed change")+
geom_abline(intercept = 0, slope = 1, color="red",linetype="dashed", size=1.5)+
geom_text(aes(label=kat),hjust=0, vjust=0)+  geom_smooth()
#tallennetaan tarvittaessa
write.csv(kat,"mean_observed_predicted_changes_pa.csv",row.names = F)
ggplot(kat, aes(x=Ap1k, y=Ayk))+
geom_point()+ geom_hline(yintercept = 0, color = "black")+
geom_vline(xintercept = 0, color = "black")+
xlab("Mean predicted change, D")+
ylab("Mean observed change")+
geom_abline(intercept = 0, slope = 1, color="red",linetype="dashed", size=1.5)+
geom_text(aes(label=kat),hjust=0, vjust=0)+  geom_smooth()
View(kat)
kat2=cbind(kat,pa_results)
ggplot(kat2, aes(x=Ayk, y=pa_D))+
geom_point()+ geom_hline(yintercept = 0, color = "black")+
geom_vline(xintercept = 0, color = "black")+
xlab("Mean predicted change, D")+
ylab("Mean observed change")+
geom_abline(intercept = 0, slope = 1, color="red",linetype="dashed", size=1.5)+
geom_text(aes(label=kat),hjust=0, vjust=0)+  geom_smooth()
ggplot(kat2, aes(x=Ayk, y=pa_D))+
geom_point()+ geom_hline(yintercept = 0, color = "black")+
geom_vline(xintercept = 0, color = "black")+
xlab("Mean observed change, D")+
ylab("Prediction accuracy")+
geom_abline(intercept = 0, slope = 1, color="red",linetype="dashed", size=1.5)+
geom_text(aes(label=kat),hjust=0, vjust=0)+  geom_smooth()
ggplot(kat2, aes(x=Ayk, y=pa_D))+
geom_point()+ geom_hline(yintercept = 0, color = "black")+
geom_vline(xintercept = 0, color = "black")+
xlab("Mean observed change")+
ylab("Prediction accuracy D")+
geom_abline(intercept = 0, slope = 1, color="red",linetype="dashed", size=1.5)+
geom_text(aes(label=kat),hjust=0, vjust=0)+  geom_smooth()
ggplot(kat2, aes(x=Ayk, y=pa_D))+
geom_point()+ geom_hline(yintercept = 0, color = "black")+
geom_vline(xintercept = 0, color = "black")+
xlab("Mean observed change")+
ylab("Prediction accuracy D")+
geom_abline(intercept = 0, slope = 1, color="red",linetype="dashed", size=1.5)
ggplot(kat2, aes(x=Ayk, y=pa_D))+
geom_point()+ geom_hline(yintercept = 0, color = "black")+
geom_vline(xintercept = 0, color = "black")+
xlab("Mean observed change")+
ylab("Prediction accuracy D")+
geom_abline(intercept = 0, slope = 1, color="red",linetype="dashed", size=1.5)+  geom_smooth()
modeltype = 2 #2 on abu-aineistolle
filename = file.path(PredictionDir, paste("predictions_",c("pa","abundance")[modeltype],                                    "_chains_",as.character(nChains),"_thin_", as.character(thin),"_samples_", as.character(samples),".Rdata",sep = ""))
load(filename) #mpred1, mpred2, Y, studyDesign
routes=levels(studyDesign$Route)
nr=length(routes)
years=levels(studyDesign$Year)
ns=dim(mpred1)[2]
pm1p1=mpred1[period1,]
pm2p1=mpred2[period1,]
pm1p2=mpred1[period2,] #pm1p2 = predictions by model 1 to period 2
pm2p2=mpred2[period2,]
y1=Y[period1,]
y2=Y[period2,]
sd1 = studyDesign[period1,]
sd2 = studyDesign[period2,]
visits1 = rep(NA,nr)
visits2 = rep(NA,nr)
for (i in 1:nr){
visits1[i] = sum(sd1$Route==routes[i])
visits2[i] = sum(sd2$Route==routes[i])
}
# COMPUTE MEASURES A AND B
selroutes = routes[which(visits2>=2)]
nsr = length(selroutes)
Ap1=matrix(NA,nrow = nsr,ncol = ns)
Ap2=matrix(NA,nrow = nsr,ncol = ns)
Ay=matrix(NA,nrow = nsr,ncol = ns)
for (j in 1:ns) {
for (i in 1:nsr){
take = which(sd2$Route == selroutes[i] & y2[,j]>-1)
Ap1[i,j] = mean(pm1p2[take,j])
Ap2[i,j] = mean(pm2p2[take,j])
Ay[i,j] = mean(y2[take,j],na.rm=T)
}}
A = rep(NA,ns)
B = rep(NA,ns)
for (i in 1:ns){
A[i] = cor(Ap2[,i],Ay[,i],use="na.or.complete")   #lisäsin tähän määreen
B[i] = cor(Ap1[,i],Ay[,i],use="na.or.complete")
}
nsr
plot(A,B,xlim=c(-1,1), ylim=c(-1,1)) + abline(0,1)+ abline(h=0)+ abline(v=0)
P_D = rep(NA,ns)
for (i in 1:ns){
P_D[i] = pairwiseCount(Ap1[,i],Ay[,i])
}
sort(P_D)
mean(P_D)
# COMPUTE MEASURES C AND D
selroutes = routes[which(visits1>=2 & visits2>=2)]
nsr = length(selroutes)
Ap1=matrix(NA,nrow = nsr,ncol = ns)
Ap2=matrix(NA,nrow = nsr,ncol = ns)
Ay=matrix(NA,nrow = nsr,ncol = ns)
for (j in 1:ns){
for (i in 1:nsr){
take1 = which(sd1$Route == selroutes[i] & y1[,j]>-1)
take2 = which(sd2$Route == selroutes[i]& y2[,j]>-1)
Ap1[i,j] = mean(pm1p2[take2,j])-mean(pm1p1[take1,j]) #ka laskettava vain vuosilta, jolloin lajia on havaittu
Ap2[i,j] = mean(pm2p2[take2,j])-mean(pm2p1[take1,j]) #riittää, että on edes kerran pystytty laskemaan lajia
Ay[i,j] = mean(y2[take2,j],na.rm=T)- mean(y1[take1,j],na.rm=T) #NA:t eivät saa estää keskiarvon laskemista koko lajille.
}}
C = rep(NA,ns)
D = rep(NA,ns)
for (i in 1:ns){
C[i] = cor(Ap2[,i],Ay[,i],use="na.or.complete")    #lisäsin tähän määreen
D[i] = cor(Ap1[,i],Ay[,i],use="na.or.complete")
}
plot(C,D,xlim=c(-1,1), ylim=c(-1,1)) + abline(0,1)+ abline(h=0)+ abline(v=0)
meres=c(mean(A,na.rm = TRUE),mean(B,na.rm = TRUE),mean(C,na.rm = TRUE),mean(D,na.rm = TRUE))
names(meres)=c("A","B","C","D")
meres
#save as datatable
species=colnames(Y)
abu_results=data.frame(species,A,B,C,D)
setnames(abu_results,c("A","B","C","D"),c("abu_A","abu_B","abu_C","abu_D"))
write.csv(abu_results, "abu_results.csv",row.names = F)
#combine data frames
res=inner_join(pa_results,abu_results,by="species")
#save as csv for further analysis
write.csv(res,"results.csv",row.names = F)
abu_results
pred=Ap1[,21]
obs=Ay[,21]
laji=as.data.frame(cbind(pred,obs))
#tarkistus
cor(pred,obs, use="na.or.complete")
#kuvaaja
ggplot(laji, aes(x=pred,y=obs))+ geom_point()+ xlim(-2,2)+ylim(-2,2)+ geom_abline(intercept = 0, slope =1) + geom_hline(yintercept=0) + geom_vline(xintercept = 0) +ggtitle("Viherpeippo")
#entäpä pohjansirkku?
pred=Ap1[,40]
obs=Ay[,40]
laji=as.data.frame(cbind(pred,obs))
#tarkistus
cor(pred,obs, use="na.or.complete")
#kuvaaja
ggplot(laji, aes(x=pred,y=obs))+ geom_point()+ xlim(-2,2)+ylim(-2,2)+ geom_abline(intercept = 0, slope =1) + geom_hline(yintercept=0) + geom_vline(xintercept = 0) +ggtitle("Pohjansirkku")
P_D = rep(NA,ns)
for (i in 1:ns){
P_D[i] = pairwiseCount(Ap1[,i],Ay[,i])
}
sort(P_D)
mean(P_D)
#liitän uuden sarakkeen tuloksiin
res=cbind(res,P_D)
#save as csv for further analysis
write.csv(res,"results.csv",row.names = F)
#kannanmuutostrendien tarkastelu, lasketaan kaikilta linjoilta ennustetut ja todelliset kannanmuutokset
Ap1<-as.data.frame(Ap1)
Ap2<-as.data.frame(Ap2)
Ay<-as.data.frame(Ay)
#aineisto, jossa kullekin lajille laskettu kaikilta linjoilta ennustettu ja todellinen muutoksen keskiarvo (EI siis korrelaatio
# ennusteiden ja oikeiden muutosten välillä kuten aiemmin on laskettu)
kat=colnames(Y)
kat=as.data.frame(kat)
kat$Ap1k=colMeans(Ap1,na.rm = T)
kat$Ap2k<-colMeans(Ap2,na.rm = T)
kat$Ayk<-colMeans(Ay,na.rm = T)
ggplot(kat, aes(x=Ap2k, y=Ayk))+ geom_point()+
geom_hline(yintercept = 0, color = "black")+
geom_vline(xintercept = 0, color = "black")+
xlab("Mean predicted change, C")+
ylab("Mean observed change")+
geom_abline(intercept = 0, slope = 1, color="red",linetype="dashed", size=1.5)
#+ geom_text(aes(label=kat),hjust=0, vjust=0) +  geom_smooth()
ggplot(kat, aes(x=Ap1k, y=Ayk))+
geom_point()+ geom_hline(yintercept = 0, color = "black")+
geom_vline(xintercept = 0, color = "black")+
xlab("Mean predicted change, D")+
ylab("Mean observed change")+
geom_abline(intercept = 0, slope = 1, color="red",linetype="dashed", size=1.5)
#+geom_text(aes(label=kat),hjust=0, vjust=0)+  geom_smooth() +xlim(-0.3,0.3)+ylim(-1,1)
write.csv(kat,"mean_observed_predicted_changes_abu.csv",row.names = F)
kat2=cbind(kat,abu_results)
ggplot(kat2, aes(x=Ayk, y=abu_D))+
geom_point()+ geom_hline(yintercept = 0, color = "black")+
geom_vline(xintercept = 0, color = "black")+
xlab("Mean observed change")+
ylab("Prediction accuracy D")+
geom_abline(intercept = 0, slope = 1, color="red",linetype="dashed", size=1.5)+
geom_text(aes(label=kat),hjust=0, vjust=0)+  geom_smooth()
ggplot(kat2, aes(x=Ayk, y=pa_D))+
geom_point()+ geom_hline(yintercept = 0, color = "black")+
geom_vline(xintercept = 0, color = "black")+
xlab("Mean observed change")+
ylab("Prediction accuracy D")+
geom_abline(intercept = 0, slope = 1, color="red",linetype="dashed", size=1.5)+  geom_smooth()
ggplot(kat2, aes(x=Ayk, y=abu_D))+
geom_point()+ geom_hline(yintercept = 0, color = "black")+
geom_vline(xintercept = 0, color = "black")+
xlab("Mean observed change")+
ylab("Prediction accuracy D")+
geom_abline(intercept = 0, slope = 1, color="red",linetype="dashed", size=1.5)+  geom_smooth()
ggplot(kat2, aes(x=Ayk, y=abu_D))+
geom_point()+ geom_hline(yintercept = 0, color = "black")+
geom_vline(xintercept = 0, color = "black")+
xlab("Mean observed change")+
ylab("Prediction accuracy D")+
geom_abline(intercept = 0, slope = 1, color="red",linetype="dashed", size=1.5)+  geom_smooth()
View(Ap1)
View(Ay)
colVars(Ay)
install.packages("matrixStats")
paketit<-c("readr","tidyr","plyr","dplyr","magrittr","purrr","data.table","plotrix","jtools","sp","GISTools","rgdal","sf","spatialEco","ggplot2","ggrepel","psych","matrixStats")
lapply(paketit,library,character.only=T)
colVars(Ay)
colVars(as.matrix(Ay))
dat=t(Ay)
View(dat)
rowVars(as.matrix(dat))
rowVars(as.matrix(dat),na.rm = TRUE)
dat2=rowVars(as.matrix(dat),na.rm = TRUE)
dat$row_var=rowVars(as.matrix(dat),na.rm = TRUE)
dat=t(Ay)
dat=as.dataframe(t(Ay))
dat=as.data.frame(t(Ay))
dat$row_var=rowVars(as.matrix(dat),na.rm = TRUE)
View(dat)
dat=cbind(dat,abu_results)
View(abu_results)
View(dat)
names(dat)
ggplot(dat, aes(x=row_var, y=abu_D))+
geom_point()+ geom_hline(yintercept = 0, color = "black")+
geom_vline(xintercept = 0, color = "black")+
xlab("Observed change, variance")+
ylab("Prediction accuracy D")+
geom_abline(intercept = 0, slope = 1, color="red",linetype="dashed", size=1.5)+
geom_text(aes(label=kat),hjust=0, vjust=0)+  geom_smooth()
summary(dat)
is.na(dat)
is.na(dat$row_var)
is.na(dat$abu_D)
ggplot(dat, aes(x=row_var, y=abu_D))+
geom_point()+ geom_hline(yintercept = 0, color = "black")+
geom_vline(xintercept = 0, color = "black")+
xlab("Observed change, variance")+
ylab("Prediction accuracy D")+
geom_abline(intercept = 0, slope = 1, color="red",linetype="dashed", size=1.5)+
geom_text(aes(label=kat),hjust=0, vjust=0)+  geom_smooth()
names(dat)
ggplot(dat, aes(x=row_var, y=abu_D))+
geom_point()+ geom_hline(yintercept = 0, color = "black")+
geom_vline(xintercept = 0, color = "black")+
xlab("Observed change, variance")+
ylab("Prediction accuracy D")+
geom_abline(intercept = 0, slope = 1, color="red",linetype="dashed", size=1.5)+
geom_text(aes(label=dat),hjust=0, vjust=0)+  geom_smooth()
ggplot(dat, aes(x=row_var, y=abu_D))+
geom_point()+ geom_hline(yintercept = 0, color = "black")+
geom_vline(xintercept = 0, color = "black")+
xlab("Observed change, variance")+
ylab("Prediction accuracy D")+
geom_abline(intercept = 0, slope = 1, color="red",linetype="dashed", size=1.5)+  geom_smooth()
knitr::opts_chunk$set(echo = TRUE)
observations=read.csv("observations.csv",header = T,sep = ";")
summary(observations[,1:16])
knitr::include_graphics('./ABCD_erikseen.png')
getwd()
localDir = "."
PredictionDir = file.path(localDir, "data")
paketit<-c("readr","tidyr","plyr","dplyr","magrittr","purrr","data.table","plotrix","jtools","sp","GISTools","rgdal","sf","spatialEco","ggplot2","ggrepel","psych","matrixStats")
lapply(paketit,library,character.only=T)
#model 1: data until 1999; model 2: full data
#mpred1: posterior mean based on model 1; mpred2: posterior mean based on model 2
samples = 1000
thin = 1000  #muista vaihtaa tämä!!
nChains = 4
modeltype = 1 #1 on pa-aineistolle
filename = file.path(PredictionDir, paste("predictions_",c("pa","abundance")[modeltype],
"_chains_",as.character(nChains),"_thin_", as.character(thin),"_samples_", as.character(samples),
".Rdata",sep = ""))
load(filename) #mpred1, mpred2, Y, studyDesign
routes=levels(studyDesign$Route)
nr=length(routes)
years=levels(studyDesign$Year)
ns=dim(mpred1)[2]
period1=(studyDesign$Year=="Year_1996" | studyDesign$Year=="Year_1997" | studyDesign$Year=="Year_1998" | studyDesign$Year=="Year_1999")
period2=(studyDesign$Year=="Year_2013" | studyDesign$Year=="Year_2014" | studyDesign$Year=="Year_2015" | studyDesign$Year=="Year_2016")
pm1p1=mpred1[period1,]
pm2p1=mpred2[period1,]
pm1p2=mpred1[period2,] #pm1p2 = predictions by model 1 to period 2
pm2p2=mpred2[period2,]
y1=Y[period1,]
y2=Y[period2,]
sd1 = studyDesign[period1,]
sd2 = studyDesign[period2,]
visits1 = rep(NA,nr)
visits2 = rep(NA,nr)
for (i in 1:nr){
visits1[i] = sum(sd1$Route==routes[i])
visits2[i] = sum(sd2$Route==routes[i])
}
# COMPUTE MEASURES A AND B
selroutes = routes[which(visits2>=2)]  #periodi 2, joten vesilintujen NA:t eivät vaikuta näissä laskuissa
nsr = length(selroutes)
Ap1=matrix(NA,nrow = nsr,ncol = ns)
Ap2=matrix(NA,nrow = nsr,ncol = ns)
Ay=matrix(NA,nrow = nsr,ncol = ns)
for (i in 1:nsr){
take = which(sd2$Route == selroutes[i])
Ap1[i,] = colMeans(pm1p2[take,])
Ap2[i,] = colMeans(pm2p2[take,])
Ay[i,] = colMeans(y2[take,])
}
A = rep(NA,ns)
B = rep(NA,ns)
for (i in 1:ns){
A[i] = cor(Ap2[,i],Ay[,i])
B[i] = cor(Ap1[,i],Ay[,i])
}
nsr
plot(A,B,xlim=c(-1,1), ylim=c(-1,1)) + abline(0,1)+ abline(h=0)+ abline(v=0)
# COMPUTE MEASURES C AND D
selroutes = routes[which(visits1>=2 & visits2>=2)]
nsr = length(selroutes)
Ap1=matrix(NA,nrow = nsr,ncol = ns)
Ap2=matrix(NA,nrow = nsr,ncol = ns)
Ay=matrix(NA,nrow = nsr,ncol = ns)
for (i in 1:nsr){
take1 = which(sd1$Route == selroutes[i])
take2 = which(sd2$Route == selroutes[i])
Ap1[i,] = colMeans(pm1p2[take2,])-colMeans(pm1p1[take1,]) #ennusteisiin ei tule NA:ta mutta seuraavissa laskuissa havaintojen NA eliminoi tämän ongelman
Ap2[i,] = colMeans(pm2p2[take2,])-colMeans(pm2p1[take1,])
Ay[i,] = colMeans(y2[take2,])- colMeans(y1[take1,])   #Suomen vesilintujen NA:t säilyvät
}
C = rep(NA,ns)
D = rep(NA,ns)
for (i in 1:ns){
C[i] = cor(Ap2[,i],Ay[,i], use="na.or.complete")  #NA:t eivät estä korrelaation laskemista koko lajille
D[i] = cor(Ap1[,i],Ay[,i], use="na.or.complete")
}
nsr
plot(C,D,xlim=c(-1,1), ylim=c(-1,1)) + abline(0,1)+ abline(h=0)+ abline(v=0)
pred=Ap1[,21]
obs=Ay[,21]
laji=as.data.frame(cbind(pred,obs))
#tarkistus
cor(pred,obs, use="na.or.complete")
#kuvaaja
ggplot(laji, aes(x=pred,y=obs))+ geom_point()+ xlim(-1,1)+ylim(-1,1)+ geom_abline(intercept = 0, slope =1) + geom_hline(yintercept=0) + geom_vline(xintercept = 0) +ggtitle("Viherpeippo")
#entäpä tikli?
pred=Ap1[,20]
obs=Ay[,20]
laji=as.data.frame(cbind(pred,obs))
#tarkistus
cor(pred,obs, use="na.or.complete")
#kuvaaja
ggplot(laji, aes(x=pred,y=obs))+ geom_point()+ xlim(-1,1)+ylim(-1,1)+ geom_abline(intercept = 0, slope =1) + geom_hline(yintercept=0) + geom_vline(xintercept = 0) +ggtitle("Tikli")
P_D = rep(NA,ns)
for (i in 1:ns){
P_D[i] = pairwiseCount(Ap1[,i],Ay[,i])
}
sort(P_D)
#create a table
meres=c(mean(A,na.rm = TRUE),mean(B,na.rm = TRUE),mean(C,na.rm = TRUE),mean(D,na.rm = TRUE))
names(meres)=c("A","B","C","D")
meres
#write.csv(meres,file="pa_species_specific_route_level.csv")
#save results as datatable for further analysis
species=colnames(Y)
pa_results=data.frame(species,A,B,C,D)
setnames(pa_results,c("A","B","C","D"),c("pa_A","pa_B","pa_C","pa_D"))
write.csv(pa_results, "pa_results.csv",row.names = F)
pa_results
#kannanmuutostrendien tarkastelu, lasketaan kaikilta linjoilta ennustetut ja todelliset kannanmuutokset
Ap1<-as.data.frame(Ap1)
Ap2<-as.data.frame(Ap2)
Ay<-as.data.frame(Ay)
#aineisto, jossa kullekin lajille laskettu kaikilta linjoilta ennustettu ja todellinen muutoksen keskiarvo (EI siis korrelaatio
# ennusteiden ja oikeiden muutosten välillä kuten aiemmin on laskettu vaan vähän niinkuin olisi poolattu koko aineisto yhteen lukemaan)
kat=colnames(Y)
kat=as.data.frame(kat)
kat$Ap1k=colMeans(Ap1,na.rm = T)
kat$Ap2k<-colMeans(Ap2,na.rm = T)
kat$Ayk<-colMeans(Ay,na.rm = T)
ggplot(kat, aes(x=Ap2k, y=Ayk))+ geom_point()+
geom_hline(yintercept = 0, color = "black")+
geom_vline(xintercept = 0, color = "black")+
xlab("Mean predicted change, C")+
ylab("Mean observed change")+
geom_abline(intercept = 0, slope = 1, color="red",linetype="dashed", size=1.5)+
geom_text(aes(label=kat),hjust=0, vjust=0) + geom_smooth()
ggplot(kat, aes(x=Ap1k, y=Ayk))+
geom_point()+ geom_hline(yintercept = 0, color = "black")+
geom_vline(xintercept = 0, color = "black")+
xlab("Mean predicted change, D")+
ylab("Mean observed change")+
geom_abline(intercept = 0, slope = 1, color="red",linetype="dashed", size=1.5)+
geom_text(aes(label=kat),hjust=0, vjust=0)+  geom_smooth()
#tallennetaan tarvittaessa
write.csv(kat,"mean_observed_predicted_changes_pa.csv",row.names = F)
kat2=cbind(kat,pa_results)
ggplot(kat2, aes(x=Ayk, y=pa_D))+
geom_point()+ geom_hline(yintercept = 0, color = "black")+
geom_vline(xintercept = 0, color = "black")+
xlab("Mean observed change")+
ylab("Prediction accuracy D")+
geom_abline(intercept = 0, slope = 1, color="red",linetype="dashed", size=1.5)+
geom_text(aes(label=kat),hjust=0, vjust=0)+  geom_smooth()
ggplot(kat2, aes(x=Ayk, y=pa_D))+
geom_point()+ geom_hline(yintercept = 0, color = "black")+
geom_vline(xintercept = 0, color = "black")+
xlab("Mean observed change")+
ylab("Prediction accuracy D")+
geom_abline(intercept = 0, slope = 1, color="red",linetype="dashed", size=1.5)+  geom_smooth()
dat=as.data.frame(t(Ay))
dat$row_var=rowVars(as.matrix(dat),na.rm = TRUE)
dat=cbind(dat,pa_results)
ggplot(dat, aes(x=row_var, y=pa_D))+
geom_point()+ geom_hline(yintercept = 0, color = "black")+
geom_vline(xintercept = 0, color = "black")+
xlab("Observed change, variance")+
ylab("Prediction accuracy D")+
geom_abline(intercept = 0, slope = 1, color="red",linetype="dashed", size=1.5)+  geom_smooth()
knitr::opts_chunk$set(echo = TRUE)
#tarvittavat paketit
paketit<-c("visreg","DHARMa","arm","performance","here","readr","tidyr","plyr","dplyr","vegan","ggplot2","lattice","psych","lme4","glmmTMB","MASS","MuMIn","mgcv","gamm4","glmmADMB")
lapply(paketit,library,character.only=T)
#aineisto
reg<-read.csv("ortolans.csv")
data<-read.csv("OrtolanBunting.csv")
#yhdistetään näistä region muuttuja mukaan aineistoon
data$region<-with(reg, region[match(data$id, id)])
names(data)
str(data)
summary(data)
#tarkasta kaikkien luokkien muoto
data$id<-as.factor(data$id)
#vuodelle oma faktori-muuttuja
data$fyear<-as.factor(data$year)
#valitaan aineisto vain vuodesta 2001 eteenpäin, NeoPrior-tietoa ei ole vuodelle 2000
data=subset(data,year!=2000)
#valitaan Pohjois-Karjala ja Keski-Suomi pois
data=subset(data,region!="PKA"&region!="KES")
data=droplevels(data)
#logaritmimuunnos pinta-alalle, luo uusi muuttuja
data$Larea=log(data$area)
mean(data$Larea)
#standardoi muuttujat uuteen data frameen niin edellisestä voi vielä tarkistaa
#mean on nolla ja sd on 0.5, Grueberin paperista otettu ohje
#area-muuttujaa eli pinta-alaa ei standardoida, niinkuin ei myöskään terri-muuttujaa
#mä siis standardoin vuoden, toivottavasti se on ok?
dataS=data %>%mutate_at(c(2:3,5:7,9:21), funs(c(scale(.)*0.5))) #ei ehkä välttämätön tämä *0.5?
dataP=data %>%mutate_at(c(2:3,5:7,9:21), funs(c(scale(.))))
#mallit
N1=glmmTMB(terri ~ year
+ offset(Larea)
+ (1 + year| id),
family=nbinom2,
data=dataS,
REML=FALSE)
N2=glmmTMB(terri ~ year + Abuild + Aroad + Astream + Ariver + agri5 + region
+ offset(Larea)
+ (1 + year| id),
family=nbinom2,
data=dataS,
REML=FALSE)
N3=glmmTMB(terri ~ year + Abuild + Aroad + Astream + Ariver + agri5 + region + NeoPrior*year
+ offset(Larea)
+ (1 + year| id),
family=nbinom2,
data=dataS,
REML=FALSE)
m21<- MCMCglmm(terri ~ year random=~id, data =
dataS,family="binom",nitt=1003000, burnin=3000, thin=1000)
m21<- MCMCglmm(terri ~ year random=~id, data = dataS, family="binom",nitt=1003000, burnin=3000, thin=1000)
m21<- MCMCglmm(terri ~ year, random=~id, data = dataS, family="binom",nitt=1003000, burnin=3000, thin=1000)
#tarvittavat paketit
paketit<-c("visreg","DHARMa","arm","performance","here","readr","tidyr","plyr","dplyr","vegan","ggplot2","lattice","psych","lme4","glmmTMB","MASS","MuMIn","mgcv","gamm4","glmmADMB","MCMCglmm")
lapply(paketit,library,character.only=T)
m21<- MCMCglmm(terri ~ year, random=~id, data = dataS, family="binom",nitt=1003000, burnin=3000, thin=1000)
m21<- MCMCglmm(terri ~ year, random=~id, data = dataS, family="gaussian",nitt=1003000, burnin=3000, thin=1000)
m21<- MCMCglmm(terri ~ year, random=~id, data = dataS, family="gaussian",nitt=10030, burnin=300, thin=10)
```{r, cache=T,results="hide"}
#tarvittavat paketit
paketit<-c("visreg","DHARMa","arm","performance","here","readr","tidyr","plyr","dplyr","vegan","ggplot2","lattice","psych","lme4","glmmTMB","MASS","MuMIn","mgcv","gamm4","glmmADMB","MCMCglmm")
lapply(paketit,library,character.only=T)
