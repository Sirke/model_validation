getwd()
paketit<-c("visreg","nlme","readr","tidyr","dplyr","plyr","magrittr","purrr","ggplot2","ape","geiger","MuMIn","psych","Hmisc")
lapply(paketit,library,character.only=T)
#aineiston valinta, leväyttäminen ja uudelleen nimeäminen
res<-read.csv("results_and_pooled.csv")
res2=subset(res,method=="pool_D")
res3=spread(res2,pa,accuracy)
res3$method=NULL
res4=res3 %>% dplyr::rename(pool_pa_change = pa, pool_abu_change = abu)
#lisätään lajiominaisuudet taulukkoon
traits<-read.csv("traits_table.csv",sep = ";")
results<-inner_join(res4,traits,by="species")
str(results)
#uusi muuttuja, massan logaritmi
results$logmass<-log(results$Mass)
#uusi muuttuja, log-muunnettu prevalenssi
results$PrevS=log(results$Prev)
#arcsin-muunnos (kokeiltu)
#asinTransform <- function(p) { asin(sqrt(p)) }
#results$PrevS=asinTransform(results$Prev)
#logit-muunnos (kokeilin, antaa ihan samanlaiset residuaalit)
#logitTransform <- function(p) { log(p/(1-p)) }
#results$PrevS=logitTransform(results$Prev)
#tallenna tarvittaessa omaksi taulukokseen
#write.csv(results,"accuracies_traits.csv",row.names = F)
#poolattu pa aineisto
op<-par(mfrow=c(2,2),mar=c(5,4,1,2))
boxplot(pool_pa_change~Hab,data=results,ylab="pool_pa_D",xlab="Habitat")
plot(pool_pa_change~PrevS, data = results,ylab="pool_pa_D",xlab="muunnos(Prevalence)")
abline(lm(pool_pa_change~PrevS,data = results))
boxplot(pool_pa_change~Mig,data=results,ylab="pool_pa_D",xlab="Migration")
plot(pool_pa_change~logmass, data = results,ylab="pool_pa_D",xlab="log(Mass)")
abline(lm(pool_pa_change~logmass,data = results))
par(op)
#poolattu abu aineisto
op<-par(mfrow=c(2,2),mar=c(5,4,1,2))
boxplot(pool_abu_change~Hab,data=results,ylab="pool_abu_D",xlab="Habitat")
plot(pool_abu_change~PrevS, data = results,ylab="pool_abu_D",xlab="muunnos(Prevalence)")
abline(lm(pool_abu_change~Prev,data = results))
boxplot(pool_abu_change~Mig,data=results,ylab="pool_abu_D",xlab="Migration")
plot(pool_abu_change~logmass, data = results,ylab="pool_abu_D",xlab="log(Mass)")
abline(lm(pool_abu_change~logmass,data = results))
par(op)
ggplot(results,aes(x=Prev,y=pool_abu_change))+geom_point(aes(colour = factor(Hab)))
ggplot(results,aes(x=logmass,y=pool_abu_change))+geom_point(aes(colour = factor(Mig)))
#luetaan aineisto sisään, Multiphylo eli monta puuta
linnut <- read.nexus("output.nex")
#valitaan vain yksi puu, mikä tahansa sadasta
linnut2<-linnut[[99]]
#define a variance-covariance structure based on the model of Brownian evolution
bm.birds=corBrownian(1,phy=linnut2)
#tehdään fylogenialistasta matriisi
lintupuu<-vcv.phylo(linnut2)
#matriisin voi värittää havainnollistamaan lintulajien sukulaisuutta
heatmap(lintupuu,Rowv = NA,Colv = NA)
#abu-aineistoa varten pari lajia pois, muuten koodi ei toimi
linnut3=drop.tip(linnut2, "Emberiza_rustica", trim.internal = TRUE, subtree = FALSE,
root.edge = 0, rooted = is.rooted(linnut2), collapse.singles = TRUE,
interactive = FALSE)
linnut4=drop.tip(linnut3, "Bonasa_bonasia", trim.internal = TRUE, subtree = FALSE,
root.edge = 0, rooted = is.rooted(linnut2), collapse.singles = TRUE,
interactive = FALSE)
bm.birds2=corBrownian(1,phy=linnut4)
#aineiston rivien nimet muutetaan lattareiksi jolloin keskustelee fylogeniapuun kanssa
rownames(results)=results$species
#luodaan eri mallivaihtoehtoja
malli0 <- gls(pool_pa_change ~ 1, data = results,correlation=bm.birds,method="ML")
malli1 <- gls(pool_pa_change ~ Mig, data = results,correlation=bm.birds,method="ML")
malli2 <- gls(pool_pa_change ~ Hab, data = results,correlation=bm.birds,method="ML")
malli3 <- gls(pool_pa_change ~ log(Mass), data = results,correlation=bm.birds,method="ML")
malli4 <- gls(pool_pa_change ~ Prev, data = results,correlation=bm.birds,method="ML")
malli5 <- gls(pool_pa_change ~ Mig + Hab, data = results,correlation=bm.birds,method="ML")
malli6 <- gls(pool_pa_change ~ Hab + log(Mass), data = results,correlation=bm.birds,method="ML")
malli7 <- gls(pool_pa_change ~ Mig + log(Mass), data = results,correlation=bm.birds,method="ML")
malli8 <- gls(pool_pa_change ~ log(Mass)+Prev, data = results,correlation=bm.birds,method="ML")
malli9 <- gls(pool_pa_change ~ Mig +Prev, data = results,correlation=bm.birds,method="ML")
malli10 <- gls(pool_pa_change ~ Hab+Prev, data = results,correlation=bm.birds,method="ML")
malli11 <- gls(pool_pa_change ~ Mig + Hab + log(Mass), data = results,correlation=bm.birds,method="ML")
malli12 <- gls(pool_pa_change ~ Mig + Hab + Prev, data = results,correlation=bm.birds,method="ML")
malli13 <- gls(pool_pa_change ~ Mig + Prev + log(Mass), data = results,correlation=bm.birds,method="ML")
malli14 <- gls(pool_pa_change ~ Prev + Hab + log(Mass), data = results,correlation=bm.birds,method="ML")
malli15 <- gls(pool_pa_change ~ Mig + Hab + log(Mass)+Prev, data = results,correlation=bm.birds,method="ML")
#mallin valintaa MuMin paketin avulla
output1<-model.sel(malli0,malli1,malli2,malli3,malli4,malli5,malli6,malli7,malli8,malli9,malli10,malli11,malli12,malli13,malli14,malli15)
# AICc Table
output1
#tehdään model averaging
topmodels = get.models(output1,subset=delta<4)
#topmodels<-model.sel(malli0,malli3,malli8,malli4)
summary(model.avg(topmodels, revised.var = TRUE))
# sovitetaan malli uudestaan REML asetuksilla
malli0 <- gls(pool_pa_change ~ 1, data = results,correlation=bm.birds,method="REML")
summary(malli0)
op<-par(mfrow=c(2,3),mar=c(5,4,1,2))
plot(malli0,add.smooth = F,which =1)
E<-resid(malli0)
hist(E, xlab = "residuals",main = "")
plot(results$Prev,E,xlab = "prevalence",ylab="residuals")
plot(results$Hab,E,xlab = "habitat",ylab="residuals")
plot(results$Mig,E,xlab = "migration",ylab="residuals")
plot(results$logmass,E,xlab = "logMass",ylab="residuals")
par(op)
#luodaan eri mallivaihtoehtoja
malli0 <- gls(pool_abu_change ~ 1, data = results,correlation=bm.birds2,method="ML",na.action="na.omit")
malli1 <- gls(pool_abu_change ~ Mig, data = results,correlation=bm.birds2,method="ML",na.action="na.omit")
malli2 <- gls(pool_abu_change ~ Hab, data = results,correlation=bm.birds2,method="ML",na.action="na.omit")
malli3 <- gls(pool_abu_change ~ logmass, data = results,correlation=bm.birds2,method="ML",na.action="na.omit")
malli4 <- gls(pool_abu_change ~ Prev, data = results,correlation=bm.birds2,method="ML",na.action="na.omit")
malli5 <- gls(pool_abu_change ~ Mig + Hab, data = results,correlation=bm.birds2,method="ML",na.action="na.omit")
malli6 <- gls(pool_abu_change ~ Hab + logmass, data = results,correlation=bm.birds2,method="ML",na.action="na.omit")
malli7 <- gls(pool_abu_change ~ Mig + logmass, data = results,correlation=bm.birds2,method="ML",na.action="na.omit")
malli8 <- gls(pool_abu_change ~ logmass + Prev, data = results,correlation=bm.birds2,method="ML",na.action="na.omit")
malli9 <- gls(pool_abu_change ~ Mig + Prev, data = results,correlation=bm.birds2,method="ML",na.action="na.omit")
malli10 <- gls(pool_abu_change ~ Hab + Prev, data = results,correlation=bm.birds2,method="ML",na.action="na.omit")
malli11 <- gls(pool_abu_change ~ Mig + Hab + logmass, data = results,correlation=bm.birds2,method="ML",na.action="na.omit")
malli12 <- gls(pool_abu_change ~ Mig + Hab + Prev, data = results,correlation=bm.birds2,method="ML",na.action="na.omit")
malli13 <- gls(pool_abu_change ~ Mig + Prev + logmass, data = results,correlation=bm.birds2,method="ML",na.action="na.omit")
malli14 <- gls(pool_abu_change ~ Prev + Hab + logmass, data = results,correlation=bm.birds2,method="ML",na.action="na.omit")
malli15 <- gls(pool_abu_change ~ Mig + Hab + logmass+Prev, data = results,correlation=bm.birds2,method="ML",na.action="na.omit")
#mallin valintaa MuMin paketin avulla
output1<-model.sel(malli0,malli1,malli2,malli3,malli4,malli5,malli6,malli7,malli8,malli9,malli10,malli11,malli12,malli13,malli14,malli15)
# AICc Table
output1
#tehdään model averaging
topmodels = get.models(output1,subset=delta<4)
#topmodels<-model.sel(malli8,malli13,malli14)
summary(model.avg(topmodels, revised.var = TRUE))
#sovitetaan malli uudestaan REML asetuksilla
malli_final <- gls(pool_abu_change ~ Prev, data = results,correlation=bm.birds2,method="REML",na.action="na.omit")
summary(malli_final)
#plottaus ei toimi jos aineistoissa on eri määrä havaintoja
results2=subset(results,species!="Emberiza_rustica" & species!="Bonasa_bonasia")
#seuraavaksi mallin validointia kuvaajista
op<-par(mfrow=c(2,3),mar=c(5,4,1,2))
plot(malli_final)
E<-resid(malli_final)
hist(E, xlab = "residuals",main = "")
plot(results2$Prev,E,xlab = "prevalence",ylab="residuals")
plot(results2$Hab,E,xlab = "habitat",ylab="residuals")
plot(results2$Mig,E,xlab = "migration",ylab="residuals")
plot(results2$logmass,E,xlab = "logMass",ylab="residuals")
par(op)
qqnorm(E)
qqline(E)
#pa-aineisto
malli0 <- gls(pool_pa_change ~ 1, data = results,correlation=bm.birds,method="ML")
malli1 <- gls(pool_pa_change ~ Mig, data = results,correlation=bm.birds,method="ML")
malli2 <- gls(pool_pa_change ~ Hab, data = results,correlation=bm.birds,method="ML")
malli3 <- gls(pool_pa_change ~ log(Mass), data = results,correlation=bm.birds,method="ML")
malli4 <- gls(pool_pa_change ~ PrevS, data = results,correlation=bm.birds,method="ML")
malli5 <- gls(pool_pa_change ~ Mig + Hab, data = results,correlation=bm.birds,method="ML")
malli6 <- gls(pool_pa_change ~ Hab + log(Mass), data = results,correlation=bm.birds,method="ML")
malli7 <- gls(pool_pa_change ~ Mig + log(Mass), data = results,correlation=bm.birds,method="ML")
malli8 <- gls(pool_pa_change ~ log(Mass)+PrevS, data = results,correlation=bm.birds,method="ML")
malli9 <- gls(pool_pa_change ~ Mig +PrevS, data = results,correlation=bm.birds,method="ML")
malli10 <- gls(pool_pa_change ~ Hab+PrevS, data = results,correlation=bm.birds,method="ML")
malli11 <- gls(pool_pa_change ~ Mig + Hab + log(Mass), data = results,correlation=bm.birds,method="ML")
malli12 <- gls(pool_pa_change ~ Mig + Hab + PrevS, data = results,correlation=bm.birds,method="ML")
malli13 <- gls(pool_pa_change ~ Mig + PrevS + log(Mass), data = results,correlation=bm.birds,method="ML")
malli14 <- gls(pool_pa_change ~ PrevS + Hab + log(Mass), data = results,correlation=bm.birds,method="ML")
malli15 <- gls(pool_pa_change ~ Mig + Hab + log(Mass)+PrevS, data = results,correlation=bm.birds,method="ML")
#mallin valintaa MuMin paketin avulla
output1<-model.sel(malli0,malli1,malli2,malli3,malli4,malli5,malli6,malli7,malli8,malli9,malli10,malli11,malli12,malli13,malli14,malli15)
# AICc Table
output1
#tehdään model averaging
topmodels = get.models(output1,subset=delta<4)
#output2<-model.sel(malli0,malli3,malli8,malli4)
topmodels
summary(model.avg(topmodels, revised.var = TRUE))
#sama hieman eri koodilla
#summary(model.avg(output1, subset=delta<4))
#luottamusvälit
confint(model.avg(topmodels, subset=delta<4))
# sovitetaan malli uudestaan REML asetuksilla
malli_final <- gls(pool_pa_change ~ 1, data = results,correlation=bm.birds,method="REML")
summary(malli_final)
op<-par(mfrow=c(2,3),mar=c(5,4,1,2))
plot(malli_final,add.smooth = F,which =1)
E<-resid(malli_final)
hist(E, xlab = "residuals",main = "")
plot(results$PrevS,E,xlab = "prevalence",ylab="residuals")
plot(results$Hab,E,xlab = "habitat",ylab="residuals")
plot(results$Mig,E,xlab = "migration",ylab="residuals")
plot(results$logmass,E,xlab = "logMass",ylab="residuals")
par(op)
#abu-aineisto
#luodaan eri mallivaihtoehtoja
malli0 <- gls(pool_abu_change ~ 1, data = results,correlation=bm.birds2,method="ML",na.action="na.omit")
malli1 <- gls(pool_abu_change ~ Mig, data = results,correlation=bm.birds2,method="ML",na.action="na.omit")
malli2 <- gls(pool_abu_change ~ Hab, data = results,correlation=bm.birds2,method="ML",na.action="na.omit")
malli3 <- gls(pool_abu_change ~ logmass, data = results,correlation=bm.birds2,method="ML",na.action="na.omit")
malli4 <- gls(pool_abu_change ~ PrevS, data = results,correlation=bm.birds2,method="ML",na.action="na.omit")
malli5 <- gls(pool_abu_change ~ Mig + Hab, data = results,correlation=bm.birds2,method="ML",na.action="na.omit")
malli6 <- gls(pool_abu_change ~ Hab + logmass, data = results,correlation=bm.birds2,method="ML",na.action="na.omit")
malli7 <- gls(pool_abu_change ~ Mig + logmass, data = results,correlation=bm.birds2,method="ML",na.action="na.omit")
malli8 <- gls(pool_abu_change ~ logmass+PrevS, data = results,correlation=bm.birds2,method="ML",na.action="na.omit")
malli9 <- gls(pool_abu_change ~ Mig +PrevS, data = results,correlation=bm.birds2,method="ML",na.action="na.omit")
malli10 <- gls(pool_abu_change ~ Hab+PrevS, data = results,correlation=bm.birds2,method="ML",na.action="na.omit")
malli11 <- gls(pool_abu_change ~ Mig + Hab + logmass, data = results,correlation=bm.birds2,method="ML",na.action="na.omit")
malli12 <- gls(pool_abu_change ~ Mig + Hab + PrevS, data = results,correlation=bm.birds2,method="ML",na.action="na.omit")
malli13 <- gls(pool_abu_change ~ Mig + PrevS + logmass, data = results,correlation=bm.birds2,method="ML",na.action="na.omit")
malli14 <- gls(pool_abu_change ~ PrevS + Hab + logmass, data = results,correlation=bm.birds2,method="ML",na.action="na.omit")
malli15 <- gls(pool_abu_change ~ Mig + Hab + logmass+PrevS, data = results,correlation=bm.birds2,method="ML",na.action="na.omit")
#mallin valintaa MuMin paketin avulla
output1<-model.sel(malli0,malli1,malli2,malli3,malli4,malli5,malli6,malli7,malli8,malli9,malli10,malli11,malli12,malli13,malli14,malli15)
# AICc Table
output1
#tehdään model averaging
topmodels = get.models(output1,subset=delta<4)
#output2<-model.sel(malli0,malli3,malli8,malli4)
summary(model.avg(topmodels, revised.var = TRUE))
#sama hieman eri koodilla
#summary(model.avg(output1, subset=delta<4))
#luottamusvälit
confint(model.avg(topmodels, subset=delta<4))
#sovitetaan malli uudestaan REML asetuksilla
malli_final <- gls(pool_abu_change ~ PrevS, data = results,correlation=bm.birds2,method="REML",na.action="na.omit")
summary(malli_final)
#malli uudestaan
model <- gls(pool_abu_change ~ log(Prev), data = results,correlation=bm.birds2,method="REML",na.action="na.omit")
summary(model)
visreg(model, "Prev")
#onhan tämä varmasti oikein? Miksi y-akselilla on f(Prev) eikä pool_abu_change? En keksi miksi.
#sama mutta muutan labelit. Poistamalla sulun ja #:n kuvaajaan saa myös smootherin
visreg(model, "Prev",ylab="Prediction accuracy",xlab="Prevalence") #,gg=TRUE)+theme_bw() + geom_smooth(method="loess", col='#FF4E37', fill='#FF4E37')
#visreg(model, "logmass",ylab="Prediction accuracy",xlab="log(Mass)") #,gg=TRUE)+theme_bw() + geom_smooth(method="loess", col='#FF4E37', fill='#FF4E37')
#selittävät muuttujat voisivat olla samassa kuvaajassakin
#mutta silloin tässä ei näy nuo residuaalit
#visreg2d(model, x="Prev", y="logmass", plot.type="image")
#plottaus ei toimi jos aineistoissa on eri määrä havaintoja
results2=subset(results,species!="Emberiza_rustica" & species!="Bonasa_bonasia")
#seuraavaksi mallin validointia kuvaajista
op<-par(mfrow=c(2,3),mar=c(5,4,1,2))
plot(malli_final)
E<-resid(malli_final)
hist(E, xlab = "residuals",main = "")
plot(results2$PrevS,E,xlab = "prevalence",ylab="residuals")
plot(results2$Hab,E,xlab = "habitat",ylab="residuals")
plot(results2$Mig,E,xlab = "migration",ylab="residuals")
plot(results2$logmass,E,xlab = "logMass",ylab="residuals")
par(op)
qqnorm(E)
qqline(E)
Fo=formula(pool_abu_change ~ Mig + Hab + logmass + Prev) #tässä pitäisi olla mukana kaikki mahdolliset interaktiotkin mutta malli ei silloin toimi
#aloitetaan perus lineaarisella mallilla
m.gls1 <- gls(Fo, data = results, correlation=bm.birds2, method="REML", na.action="na.omit")
summary(m.gls1)
op<-par(mfrow=c(2,3),mar=c(5,4,1,2))
plot(m.gls1,add.smooth = F,which =1)
E<-resid(m.gls1)
hist(E, xlab = "residuals",main = "")
plot(results2$Prev,E,xlab = "prevalence",ylab="residuals")
plot(results2$Hab,E,xlab = "habitat",ylab="residuals")
plot(results2$Mig,E,xlab = "migration",ylab="residuals")
plot(results2$logmass,E,xlab = "logMass",ylab="residuals")
par(op)
#tehdään malleja, joissa on erilaisia varianssirakenteita
vf2<-varExp(form=~Prev)
m.gls2 <- gls(Fo, weights=vf2, data = results, correlation=bm.birds2, method="REML", na.action="na.omit")
vf3<-varExp(form=~logmass)
m.gls3 <- gls(Fo, weights=vf3, data = results, correlation=bm.birds2, method="REML", na.action="na.omit")
vf4<-varIdent(form=~1|Hab)
m.gls4 <- gls(Fo, weights=vf4, data = results, correlation=bm.birds2, method="REML", na.action="na.omit")
vf5<-varIdent(form=~1|Mig)
m.gls5 <- gls(Fo, weights=vf5, data = results, correlation=bm.birds2, method="REML", na.action="na.omit")
vf6<-varIdent(form=~1|Mig*Hab)
m.gls6 <- gls(Fo, weights=vf6, data = results, correlation=bm.birds2, method="REML", na.action="na.omit")
vf7<-varComb(varIdent(form=~1|Mig),varExp(form=~Prev))
m.gls7 <- gls(Fo, weights=vf7, data = results, correlation=bm.birds2, method="REML", na.action="na.omit")
#verrataan kaikkia malleja
AIC(m.gls1,m.gls2,m.gls3,m.gls4,m.gls5,m.gls6,m.gls7)
op<-par(mfrow=c(2,3),mar=c(5,4,1,2))
plot(m.gls7,add.smooth = F,which =1)
E<-resid(m.gls7,type="normalized")    #huom! tässä oltava normalized residuaalit
hist(E, xlab = "residuals",main = "")
plot(results2$Prev,E,xlab = "prevalence",ylab="residuals")
plot(results2$Hab,E,xlab = "habitat",ylab="residuals")
plot(results2$Mig,E,xlab = "migration",ylab="residuals")
plot(results2$logmass,E,xlab = "logMass",ylab="residuals")
par(op)
#luodaan eri mallivaihtoehtoja
malli0 <- gls(pool_abu_change ~ 1, weights=vf7, data = results,correlation=bm.birds2,method="ML",na.action="na.omit")
malli1 <- gls(pool_abu_change ~ Mig, weights=vf7, data = results,correlation=bm.birds2,method="ML",na.action="na.omit")
malli2 <- gls(pool_abu_change ~ Hab, weights=vf7, data = results,correlation=bm.birds2,method="ML",na.action="na.omit")
malli3 <- gls(pool_abu_change ~ logmass, weights=vf7, data = results,correlation=bm.birds2,method="ML",na.action="na.omit")
malli4 <- gls(pool_abu_change ~ Prev, weights=vf7, data = results,correlation=bm.birds2,method="ML",na.action="na.omit")
malli5 <- gls(pool_abu_change ~ Mig + Hab, weights=vf7, data = results,correlation=bm.birds2,method="ML",na.action="na.omit")
malli6 <- gls(pool_abu_change ~ Hab + logmass, weights=vf7, data = results,correlation=bm.birds2,method="ML",na.action="na.omit")
malli7 <- gls(pool_abu_change ~ Mig + logmass, weights=vf7, data = results,correlation=bm.birds2,method="ML",na.action="na.omit")
malli8 <- gls(pool_abu_change ~ logmass+Prev, weights=vf7, data = results,correlation=bm.birds2,method="ML",na.action="na.omit")
malli9 <- gls(pool_abu_change ~ Mig +Prev, weights=vf7, data = results,correlation=bm.birds2,method="ML",na.action="na.omit")
malli10 <- gls(pool_abu_change ~ Hab+Prev, weights=vf7, data = results,correlation=bm.birds2,method="ML",na.action="na.omit")
malli11 <- gls(pool_abu_change ~ Mig + Hab + logmass, weights=vf7, data = results,correlation=bm.birds2,method="ML",na.action="na.omit")
malli12 <- gls(pool_abu_change ~ Mig + Hab + Prev, weights=vf7, data = results,correlation=bm.birds2,method="ML",na.action="na.omit")
malli13 <- gls(pool_abu_change ~ Mig + Prev + logmass, weights=vf7, data = results,correlation=bm.birds2,method="ML",na.action="na.omit")
malli14 <- gls(pool_abu_change ~ Prev + Hab + logmass, weights=vf7, data = results,correlation=bm.birds2,method="ML",na.action="na.omit")
malli15 <- gls(pool_abu_change ~ Mig + Hab + logmass+Prev, weights=vf7, data = results,correlation=bm.birds2,method="ML",na.action="na.omit")
#mallin valintaa MuMin paketin avulla
output1<-model.sel(malli0,malli1,malli2,malli3,malli4,malli5,malli6,malli7,malli8,malli9,malli10,malli11,malli12,malli13,malli14,malli15)
# AICc Table
output1
summary(malli1)
malli1A <- gls(pool_abu_change ~ Mig, weights=vf7, data = results,correlation=bm.birds2,method="REML",na.action="na.omit")
anova(malli1A)
#seuraavaksi mallin validointia kuvaajista
op<-par(mfrow=c(2,3),mar=c(5,4,1,2))
plot(malli1A,add.smooth = F,which =1)
E<-resid(malli1A,type="normalized")    #huom! tässä oltava normalized residuaalit
hist(E, xlab = "residuals",main = "")
plot(results2$Prev,E,xlab = "prevalence",ylab="residuals")
plot(results2$Hab,E,xlab = "habitat",ylab="residuals")
plot(results2$Mig,E,xlab = "migration",ylab="residuals")
plot(results2$logmass,E,xlab = "logMass",ylab="residuals")
par(op)
knitr::opts_chunk$set(echo = TRUE)
getwd()
paketit<-c("visreg","nlme","readr","tidyr","dplyr","plyr","magrittr","purrr","ggplot2","ape","geiger","MuMIn","psych","Hmisc")
lapply(paketit,library,character.only=T)
#aineiston valinta, leväyttäminen ja uudelleen nimeäminen
res<-read.csv("results_and_pooled.csv")
res2=subset(res,method=="pool_D")
res3=spread(res2,pa,accuracy)
res3$method=NULL
res4=res3 %>% dplyr::rename(pool_pa_change = pa, pool_abu_change = abu)
#lisätään lajiominaisuudet taulukkoon
traits<-read.csv("traits_table.csv",sep = ";")
results<-inner_join(res4,traits,by="species")
str(results)
#uusi muuttuja, massan logaritmi
results$logmass<-log(results$Mass)
#uusi muuttuja, log-muunnettu prevalenssi
results$PrevS=log(results$Prev)
#arcsin-muunnos (kokeiltu)
#asinTransform <- function(p) { asin(sqrt(p)) }
#results$PrevS=asinTransform(results$Prev)
#logit-muunnos (kokeilin, antaa ihan samanlaiset residuaalit)
#logitTransform <- function(p) { log(p/(1-p)) }
#results$PrevS=logitTransform(results$Prev)
#tallenna tarvittaessa omaksi taulukokseen
#write.csv(results,"accuracies_traits.csv",row.names = F)
#poolattu pa aineisto
op<-par(mfrow=c(2,2),mar=c(5,4,1,2))
boxplot(pool_pa_change~Hab,data=results,ylab="pool_pa_D",xlab="Habitat")
plot(pool_pa_change~Prev, data = results,ylab="pool_pa_D",xlab="Prevalence")
abline(lm(pool_pa_change~Prev,data = results))
boxplot(pool_pa_change~Mig,data=results,ylab="pool_pa_D",xlab="Migration")
plot(pool_pa_change~Mass, data = results,ylab="pool_pa_D",xlab="Mass")
abline(lm(pool_pa_change~Mass,data = results))
par(op)
#poolattu abu aineisto
op<-par(mfrow=c(2,2),mar=c(5,4,1,2))
boxplot(pool_abu_change~Hab,data=results,ylab="pool_abu_D",xlab="Habitat")
plot(pool_abu_change~Prev, data = results,ylab="pool_abu_D",xlab="Prevalence")
abline(lm(pool_abu_change~Prev,data = results))
boxplot(pool_abu_change~Mig,data=results,ylab="pool_abu_D",xlab="Migration")
plot(pool_abu_change~Mass, data = results,ylab="pool_abu_D",xlab="Mass")
abline(lm(pool_abu_change~Mass,data = results))
par(op)
ggplot(results,aes(x=Prev,y=pool_abu_change))+geom_point(aes(colour = factor(Hab)))
ggplot(results,aes(x=Mass,y=pool_abu_change))+geom_point(aes(colour = factor(Mig)))
pairs(results2)
pairs(results)
View(results)
pairs(results[2,4,5,6,7])
pairs(results[2,4:7])
pairs(results[6:7])
pairs(results[8:9])
#luetaan aineisto sisään, Multiphylo eli monta puuta
linnut <- read.nexus("output.nex")
#valitaan vain yksi puu, mikä tahansa sadasta
linnut2<-linnut[[99]]
#define a variance-covariance structure based on the model of Brownian evolution
bm.birds=corBrownian(1,phy=linnut2)
#tehdään fylogenialistasta matriisi
lintupuu<-vcv.phylo(linnut2)
#matriisin voi värittää havainnollistamaan lintulajien sukulaisuutta
heatmap(lintupuu,Rowv = NA,Colv = NA)
#abu-aineistoa varten pari lajia pois, muuten koodi ei toimi
linnut3=drop.tip(linnut2, "Emberiza_rustica", trim.internal = TRUE, subtree = FALSE,
root.edge = 0, rooted = is.rooted(linnut2), collapse.singles = TRUE,
interactive = FALSE)
linnut4=drop.tip(linnut3, "Bonasa_bonasia", trim.internal = TRUE, subtree = FALSE,
root.edge = 0, rooted = is.rooted(linnut2), collapse.singles = TRUE,
interactive = FALSE)
bm.birds2=corBrownian(1,phy=linnut4)
#aineiston rivien nimet muutetaan lattareiksi jolloin keskustelee fylogeniapuun kanssa
rownames(results)=results$species
#pa-aineisto
malli0 <- gls(pool_pa_change ~ 1, data = results,correlation=bm.birds,method="ML")
malli1 <- gls(pool_pa_change ~ Mig, data = results,correlation=bm.birds,method="ML")
malli2 <- gls(pool_pa_change ~ Hab, data = results,correlation=bm.birds,method="ML")
malli3 <- gls(pool_pa_change ~ log(Mass), data = results,correlation=bm.birds,method="ML")
malli4 <- gls(pool_pa_change ~ PrevS, data = results,correlation=bm.birds,method="ML")
malli5 <- gls(pool_pa_change ~ Mig + Hab, data = results,correlation=bm.birds,method="ML")
malli6 <- gls(pool_pa_change ~ Hab + log(Mass), data = results,correlation=bm.birds,method="ML")
malli7 <- gls(pool_pa_change ~ Mig + log(Mass), data = results,correlation=bm.birds,method="ML")
malli8 <- gls(pool_pa_change ~ log(Mass)+PrevS, data = results,correlation=bm.birds,method="ML")
malli9 <- gls(pool_pa_change ~ Mig +PrevS, data = results,correlation=bm.birds,method="ML")
malli10 <- gls(pool_pa_change ~ Hab+PrevS, data = results,correlation=bm.birds,method="ML")
malli11 <- gls(pool_pa_change ~ Mig + Hab + log(Mass), data = results,correlation=bm.birds,method="ML")
malli12 <- gls(pool_pa_change ~ Mig + Hab + PrevS, data = results,correlation=bm.birds,method="ML")
malli13 <- gls(pool_pa_change ~ Mig + PrevS + log(Mass), data = results,correlation=bm.birds,method="ML")
malli14 <- gls(pool_pa_change ~ PrevS + Hab + log(Mass), data = results,correlation=bm.birds,method="ML")
malli15 <- gls(pool_pa_change ~ Mig + Hab + log(Mass)+PrevS, data = results,correlation=bm.birds,method="ML")
#mallin valintaa MuMin paketin avulla
output1<-model.sel(malli0,malli1,malli2,malli3,malli4,malli5,malli6,malli7,malli8,malli9,malli10,malli11,malli12,malli13,malli14,malli15)
# AICc Table
output1
#tehdään model averaging
topmodels = get.models(output1,subset=delta<4)
#output2<-model.sel(malli0,malli3,malli8,malli4)
summary(model.avg(topmodels, revised.var = TRUE))
#sama hieman eri koodilla
#summary(model.avg(output1, subset=delta<4))
#luottamusvälit
confint(model.avg(topmodels, subset=delta<4))
# sovitetaan malli uudestaan REML asetuksilla
malli_final <- gls(pool_pa_change ~ logmass, data = results,correlation=bm.birds,method="REML")
summary(malli_final)
op<-par(mfrow=c(2,3),mar=c(5,4,1,2))
plot(malli_final,add.smooth = F,which =1)
E<-resid(malli_final)
hist(E, xlab = "residuals",main = "")
plot(results$PrevS,E,xlab = "prevalence",ylab="residuals")
plot(results$Hab,E,xlab = "habitat",ylab="residuals")
plot(results$Mig,E,xlab = "migration",ylab="residuals")
plot(results$logmass,E,xlab = "logMass",ylab="residuals")
par(op)
#abu-aineisto
#luodaan eri mallivaihtoehtoja
malli0 <- gls(pool_abu_change ~ 1, data = results,correlation=bm.birds2,method="ML",na.action="na.omit")
malli1 <- gls(pool_abu_change ~ Mig, data = results,correlation=bm.birds2,method="ML",na.action="na.omit")
malli2 <- gls(pool_abu_change ~ Hab, data = results,correlation=bm.birds2,method="ML",na.action="na.omit")
malli3 <- gls(pool_abu_change ~ logmass, data = results,correlation=bm.birds2,method="ML",na.action="na.omit")
malli4 <- gls(pool_abu_change ~ PrevS, data = results,correlation=bm.birds2,method="ML",na.action="na.omit")
malli5 <- gls(pool_abu_change ~ Mig + Hab, data = results,correlation=bm.birds2,method="ML",na.action="na.omit")
malli6 <- gls(pool_abu_change ~ Hab + logmass, data = results,correlation=bm.birds2,method="ML",na.action="na.omit")
malli7 <- gls(pool_abu_change ~ Mig + logmass, data = results,correlation=bm.birds2,method="ML",na.action="na.omit")
malli8 <- gls(pool_abu_change ~ logmass+PrevS, data = results,correlation=bm.birds2,method="ML",na.action="na.omit")
malli9 <- gls(pool_abu_change ~ Mig +PrevS, data = results,correlation=bm.birds2,method="ML",na.action="na.omit")
malli10 <- gls(pool_abu_change ~ Hab+PrevS, data = results,correlation=bm.birds2,method="ML",na.action="na.omit")
malli11 <- gls(pool_abu_change ~ Mig + Hab + logmass, data = results,correlation=bm.birds2,method="ML",na.action="na.omit")
malli12 <- gls(pool_abu_change ~ Mig + Hab + PrevS, data = results,correlation=bm.birds2,method="ML",na.action="na.omit")
malli13 <- gls(pool_abu_change ~ Mig + PrevS + logmass, data = results,correlation=bm.birds2,method="ML",na.action="na.omit")
malli14 <- gls(pool_abu_change ~ PrevS + Hab + logmass, data = results,correlation=bm.birds2,method="ML",na.action="na.omit")
malli15 <- gls(pool_abu_change ~ Mig + Hab + logmass+PrevS, data = results,correlation=bm.birds2,method="ML",na.action="na.omit")
#mallin valintaa MuMin paketin avulla
output1<-model.sel(malli0,malli1,malli2,malli3,malli4,malli5,malli6,malli7,malli8,malli9,malli10,malli11,malli12,malli13,malli14,malli15)
# AICc Table
output1
#tehdään model averaging
topmodels = get.models(output1,subset=delta<4)
#output2<-model.sel(malli0,malli3,malli8,malli4)
summary(model.avg(topmodels, revised.var = TRUE))
#sama hieman eri koodilla
#summary(model.avg(output1, subset=delta<4))
#luottamusvälit
confint(model.avg(topmodels, subset=delta<4))
#sovitetaan malli uudestaan REML asetuksilla
malli_final <- gls(pool_abu_change ~ PrevS + Hab + logmass, data = results,correlation=bm.birds2,method="REML",na.action="na.omit")
summary(malli_final)
#malli uudestaan
model <- gls(pool_abu_change ~ log(Prev) + Hab + log(Mass), data = results,correlation=bm.birds2,method="REML",na.action="na.omit")
summary(model)
visreg(model, "Prev")
#onhan tämä varmasti oikein? Miksi y-akselilla on f(Prev) eikä pool_abu_change? En keksi miksi.
#sama mutta muutan labelit. Poistamalla sulun ja #:n kuvaajaan saa myös smootherin
visreg(model, "Prev",ylab="Prediction accuracy",xlab="Prevalence") #,gg=TRUE)+theme_bw() + geom_smooth(method="loess", col='#FF4E37', fill='#FF4E37')
#visreg(model, "logmass",ylab="Prediction accuracy",xlab="log(Mass)") #,gg=TRUE)+theme_bw() + geom_smooth(method="loess", col='#FF4E37', fill='#FF4E37')
#selittävät muuttujat voisivat olla samassa kuvaajassakin
#mutta silloin tässä ei näy nuo residuaalit
#visreg2d(model, x="Prev", y="logmass", plot.type="image")
#plottaus ei toimi jos aineistoissa on eri määrä havaintoja
results2=subset(results,species!="Emberiza_rustica" & species!="Bonasa_bonasia")
#seuraavaksi mallin validointia kuvaajista
op<-par(mfrow=c(2,3),mar=c(5,4,1,2))
plot(malli_final)
E<-resid(malli_final)
hist(E, xlab = "residuals",main = "")
plot(results2$PrevS,E,xlab = "prevalence",ylab="residuals")
plot(results2$Hab,E,xlab = "habitat",ylab="residuals")
plot(results2$Mig,E,xlab = "migration",ylab="residuals")
plot(results2$logmass,E,xlab = "logMass",ylab="residuals")
par(op)
qqnorm(E)
qqline(E)
#plottaus ei toimi jos aineistoissa on eri määrä havaintoja
results2=subset(results,species!="Emberiza_rustica" & species!="Bonasa_bonasia")
#seuraavaksi mallin validointia kuvaajista
op<-par(mfrow=c(2,3),mar=c(5,4,1,2))
plot(malli_final)
E<-resid(malli_final)
hist(E, xlab = "residuals",main = "")
plot(results2$PrevS,E,xlab = "logPrevalence",ylab="residuals")
plot(results2$Hab,E,xlab = "habitat",ylab="residuals")
plot(results2$Mig,E,xlab = "migration",ylab="residuals")
plot(results2$logmass,E,xlab = "logMass",ylab="residuals")
par(op)
qqnorm(E)
qqline(E)
#malli uudestaan
model <- gls(pool_abu_change ~ log(Prev) + Hab + log(Mass), data = results,correlation=bm.birds2,method="REML",na.action="na.omit")
summary(model)
visreg(model, "Prev")
#onhan tämä varmasti oikein? Miksi y-akselilla on f(Prev) eikä pool_abu_change? En keksi miksi.
#sama mutta muutan labelit. Poistamalla sulun ja #:n kuvaajaan saa myös smootherin
visreg(model, "Prev",ylab="Prediction accuracy",xlab="Prevalence") #,gg=TRUE)+theme_bw() + geom_smooth(method="loess", col='#FF4E37', fill='#FF4E37')
#visreg(model, "logmass",ylab="Prediction accuracy",xlab="log(Mass)") #,gg=TRUE)+theme_bw() + geom_smooth(method="loess", col='#FF4E37', fill='#FF4E37')
#selittävät muuttujat voisivat olla samassa kuvaajassakin
#mutta silloin tässä ei näy nuo residuaalit
#visreg2d(model, x="Prev", y="logmass", plot.type="image")
